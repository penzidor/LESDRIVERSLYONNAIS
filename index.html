<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Les Drivers Lyonnais - Ultimate Edition</title>
<style>
    body {
        margin: 0; padding: 0; 
        background-color: #1a1a2e;
        overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif;
        user-select: none; -webkit-user-select: none;
    }
    canvas {
        display: block; margin: 0 auto;
        position: absolute; top: 0; left: 0; z-index: 10;
        image-rendering: pixelated; 
    }
    
    /* HUD GAUCHE */
    #ui {
        position: absolute; top: 10px; left: 15px; color: #fff;
        font-family: 'Courier New', monospace; pointer-events: none; z-index: 30;
    }
    .hud-line {
        font-size: 20px; font-weight: bold; text-shadow: 2px 2px 0px #000;
        margin-bottom: 5px;
    }
    #hearts { color: #ff3333; font-size: 24px; }

    /* HUD DROIT (Vitesse) - STYLE N√âON */
    #speedometer {
        position: absolute; top: 10px; 
        right: 10px; 
        color: #fff;
        font-family: 'Courier New', monospace; pointer-events: none; z-index: 30;
        font-size: 11px; 
        font-weight: bold; text-shadow: 1px 1px 0px #000;
        padding: 3px 6px; 
        line-height: 1.1;

        border: 2px solid #00ffff; 
        border-radius: 8px;
        background-color: rgba(0,0,0,0.4);
        box-shadow: 
            0 0 5px rgba(0, 255, 255, 0.7),
            inset 0 0 5px rgba(0, 255, 255, 0.3);
    }
    #speedVal {
        color: #00ffff;
        text-shadow: 0 0 4px #00ffff;
        font-weight: 800;
        display: inline-block;
        font-size: 16px; 
    }
    #speedometer .hud-label {
        font-size: 11px;
        color: #aaa;
        display: inline;
    }

    /* BOUTON PAUSE */
    #pause-btn {
        position: absolute; top: 60px; right: 10px;
        font-size: 30px; cursor: pointer; z-index: 40;
        filter: drop-shadow(0 0 2px black);
        transition: transform 0.1s;
        display: none; 
    }
    #pause-btn:active { transform: scale(0.9); }

    /* ALERTES & NOTES */
    #alert-msg {
        position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%);
        font-family: 'Arial Black', sans-serif; font-size: 24px; 
        text-align: center; display: none; z-index: 60; pointer-events: none;
        padding: 15px 30px; border-radius: 10px; border: 4px solid white;
        background: rgba(0,0,0,0.85); text-shadow: 0 0 10px black;
        width: 80%; box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }

    #photo-grade {
        position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg);
        font-family: 'Arial Black', sans-serif; font-size: 60px; 
        color: #ff00ff; text-shadow: 5px 5px 0px #00ffff;
        display: none; z-index: 80; pointer-events: none;
        animation: pop 0.5s ease-out;
        white-space: pre; text-align: center;
    }
    @keyframes pop { 0% {transform: translate(-50%, -50%) scale(0);} 80% {transform: translate(-50%, -50%) scale(1.2);} 100% {transform: translate(-50%, -50%) scale(1);} }

    /* FLASH ECRAN */
    #flash-overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: white; opacity: 0; pointer-events: none; z-index: 70;
        transition: opacity 0.1s;
    }
    .spotter-flash {
        position: absolute; background: white; border-radius: 50%;
        opacity: 0; pointer-events: none; z-index: 71;
        box-shadow: 0 0 20px 10px white;
    }

    /* --- CONTR√îLES --- */

    #brake-btn {
        position: absolute; bottom: 10px; left: 20px;
        width: 70px; height: 100px;
        background-image: url('https://i.ibb.co/vCXmMHbH/058451a1-cbfc-4624-b9b1-1dc40c1db1ce.jpg');
        background-size: contain; background-repeat: no-repeat; background-position: center;

        border: 3px solid #00ffff; border-radius: 12px; 
        box-shadow: 0 0 5px rgba(0, 255, 255, 0.7), 0 0 10px rgba(0, 255, 255, 0.5), inset 0 0 5px rgba(0, 255, 255, 0.3); 
        background-color: rgba(0,0,0,0.3); 
        
        color: white; font-weight: 900; font-size: 16px;
        text-shadow: 2px 2px 4px #000, 0 0 5px #00ffff; 
        cursor: pointer; display: none; 
        
        align-items: flex-end; justify-content: center;
        padding-bottom: 15px; box-sizing: border-box;
        
        z-index: 50; transition: transform 0.1s, filter 0.2s, box-shadow 0.2s, border-color 0.2s;
    }
    #brake-btn.active { 
        transform: scale(0.90) translateY(5px);
        filter: sepia(1) saturate(5) hue-rotate(-50deg) brightness(1.5);
        border-color: #ff0000;
        box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff3300, inset 0 0 10px #ff0000;
        text-shadow: 2px 2px 4px #000, 0 0 10px #ff0000;
    }
    #brake-btn.cooldown {
        cursor: not-allowed; transform: scale(1);
        border-color: #444; box-shadow: none;
        filter: grayscale(100%) brightness(0.5); opacity: 0.7; text-shadow: none;
    }

    #nos-container {
        position: absolute; bottom: 10px; right: 10px;
        display: none; flex-direction: column; align-items: center; z-index: 50;
    }
    #nos-bar-bg {
        width: 90px; height: 10px; background: #333; border: 2px solid #fff;
        border-radius: 10px; overflow: hidden; margin-bottom: 5px;
    }
    #nos-bar-fill {
        width: 0%; height: 100%; background: linear-gradient(90deg, #00ffff, #0000ff);
        transition: width 0.2s ease-out;
    }
    #nos-btn {
        width: 90px; height: 90px; border-radius: 50%;
        background: radial-gradient(circle, #333, #111);
        border: 2px solid #00ffff; color: #00ffff;
        text-shadow: 0 0 5px #00ffff;
        box-shadow: 0 0 5px rgba(0, 255, 255, 0.3), inset 0 0 5px rgba(0, 255, 255, 0.2);
        font-weight: bold; font-size: 24px; cursor: default;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.3s; opacity: 0.6;
        text-align: center; line-height: 1; 
        pointer-events: auto;
        user-select: none;
    }
    #nos-btn.ready {
        background: radial-gradient(circle, #ff0000, #990000);
        border-color: #ffaaaa; color: white; cursor: pointer;
        opacity: 1; box-shadow: 0 0 25px #ff0000; text-shadow: 0 0 10px white;
        animation: pulse 1s infinite;
    }
    @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }
    
    .screen-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(20, 10, 40, 0.98); 
        display: flex; flex-direction: column;
        justify-content: flex-start; align-items: center;
        color: white; z-index: 100; pointer-events: auto;
        overflow-y: auto; touch-action: pan-y; -webkit-overflow-scrolling: touch;
        padding-top: 50px; padding-bottom: 50px; box-sizing: border-box;
    }
    #leaderboardScreen, #gameOverScreen, #instructionsScreen, #vipLoginScreen, #vipMenuScreen, #pauseScreen, #careerScreen, #menuScreen, #titleScreen { display: none; z-index: 110; }
    
    h1 { color: #ff00ff; text-shadow: 3px 3px #00ffff; margin-bottom: 5px; text-align: center; font-style: italic; font-size: 32px; font-family: 'Courier New', monospace;}
    
    /* VIP MENU GRID */
    #vipGrid, #upgradesGrid {
        display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 95%; max-width: 600px;
    }
    .vip-card, .upgrade-card {
        width: 140px; background: rgba(0,0,0,0.6); border: 2px solid #555; border-radius: 8px;
        padding: 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer;
        transition: transform 0.1s, border-color 0.2s;
    }
    .vip-card:active, .upgrade-card:active { transform: scale(0.95); }
    .vip-card h4, .upgrade-card h4 { margin: 5px 0; color: #fff; font-size: 14px; text-align: center; }
    .vip-card span, .upgrade-card span { font-size: 10px; color: #aaa; text-align: center; }
    .vip-card.selected { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; }

    /* STYLE CARRI√àRE SP√âCIFIQUE */
    .upgrade-card { cursor: default; }
    .upgrade-card h4 { color: #00ffff; }
    .upgrade-card .level-dots { color: #00ff00; letter-spacing: 2px; margin: 5px 0; font-size: 12px; }
    .buy-btn {
        background: #00aa00; color: white; border: none; padding: 5px 10px; margin-top: 5px;
        cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; width: 100%;
        border-radius: 4px;
    }
    .buy-btn:disabled { background: #555; color: #888; cursor: not-allowed; }

    /* GAME OVER STYLING */
    #gameOverTitle { color: #ff0000; font-size: 28px; text-shadow: 0 0 10px #ff0000, 0 0 20px #800000; margin-bottom: 15px; }
    .final-score-line { font-family: 'Courier New', monospace; font-size: 18px; margin-bottom: 6px; }
    .final-score-value { color: #00ffff; text-shadow: 0 0 5px #00ffff; font-weight: bold; }
    
    #highScoreZone { background: rgba(0, 255, 0, 0.1); border: 2px solid #00ff00; padding: 10px; border-radius: 8px; margin-top: 10px; margin-bottom: 10px; display: none; flex-direction: column; align-items: center; }
    #nameInput, #vipPasswordInput { padding: 5px; margin-top: 5px; margin-bottom: 5px; font-size: 16px; background: #111; border: 2px solid #00ff00; color: #00ffff; text-align: center; width: 180px; }
    #submitBtn, #loginBtn { background: #00aa00; border: 1px solid #00ff00; color: white; padding: 5px 15px; font-size: 14px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; margin-top: 5px; }
    
    #vipPasswordInput { border-color: #ff00ff; color: #ff00ff; width: 200px; padding: 10px; }
    #loginBtn { background: #550055; border-color: #ff00ff; }
    
    p { color: #ccc; margin-bottom: 25px; font-size: 14px; letter-spacing: 1px;}
    #garage { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; pointer-events: auto; }
    .car-box { width: 140px; height: 180px; border: 4px solid #00ffff; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; flex-shrink: 0; }
    #previewCanvas { width: 100%; height: 100%; }
    .nav-btn { background: #3a1a5a; border: 2px solid #ff00ff; color: #00ffff; font-size: 24px; width: 50px; height: 50px; cursor: pointer; margin: 0 15px; display: flex; align-items: center; justify-content: center; transition: 0.1s; z-index: 101; pointer-events: auto; }
    #carName { color: #00ffff; margin-top: 5px; font-size: 22px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 0px #ff00ff; font-family: 'Courier New', monospace; }
    #carStats { font-family: 'Courier New', monospace; font-size: 16px; color: #fff; margin-bottom: 20px; text-align: center; line-height: 1.6; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; border: 1px solid #555; }
    .stat-bar { color: #ffff00; text-shadow: 0 0 5px #ff0000; }
    
    button.action-btn { margin-top: 10px; padding: 15px 40px; font-size: 20px; background: #ff00ff; border: 3px solid #00ffff; color: white; box-shadow: 4px 4px 0px rgba(0,0,0,0.8); font-weight: bold; cursor: pointer; text-transform: uppercase; font-family: 'Courier New', monospace; z-index: 101; pointer-events: auto; display: block; margin-bottom: 10px; }
    button.secondary-btn { background: #3a1a5a; border-color: #aaa; color: #ccc; font-size: 16px; padding: 10px 20px; }

    .leaderboard-content { display: flex; align-items: center; justify-content: center; gap: 15px; width: 90%; max-width: 500px; flex-wrap: wrap; }
    #scoreTable { flex: 1; border-collapse: collapse; font-family: 'Courier New', monospace; background: rgba(0,0,0,0.5); border-radius: 10px; padding: 10px; min-width: 250px; }
    #scoreTable th { border-bottom: 2px solid #00ffff; padding: 8px; color: #ff00ff; font-size: 14px;}
    #scoreTable td { padding: 6px; text-align: center; border-bottom: 1px solid #555; font-size: 14px;}
    #scoreTable tr:first-child td { color: yellow; font-weight: bold; }
    #pilotMascot { width: 100px; height: auto; filter: drop-shadow(0 0 10px #00ffff); }

    .instruction-section { max-width: 500px; width: 90%; margin: 10px auto; padding: 15px; border: 1px solid #00ffff; background: rgba(0, 0, 0, 0.5); border-radius: 5px; text-align: left; }
    .instruction-section h3 { color: #ff00ff; text-shadow: 0 0 5px #ff00ff; margin-top: 0; margin-bottom: 5px; font-size: 18px; }
</style>
</head>
<body>

<div id="flash-overlay"></div>
<div id="alert-msg">ATTENTION</div>
<div id="photo-grade">S</div>

<div id="ui">
    <div class="hud-line">DIST: <span id="distVal">0.0</span> km</div>
    <div class="hud-line">VIES: <span id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    <div class="hud-line" style="color:#ffd700; text-shadow: 2px 2px 0 #b8860b;">PI√àCES: <span id="coinsVal">0</span> ü¶Å</div>
    <div class="hud-line" style="font-size:16px; color:#aaa;" id="timer">00:00</div>
    <div class="hud-line" style="font-size:16px; color:#ffff00;">BONUS PHOTO: <span id="photoScore">0</span></div>
</div>

<div id="speedometer">
    <span class="hud-label">VITESSE:</span> <span id="speedVal">0 km/h</span>
</div>

<div id="pause-btn" onclick="togglePause()">‚è∏Ô∏è</div>

<div id="brake-btn" ontouchstart="triggerBrake(event)" onmousedown="triggerBrake(event)">FREIN</div>

<div id="nos-container">
    <div id="nos-bar-bg"><div id="nos-bar-fill"></div></div>
    <div id="nos-btn" ontouchstart="activateNOS(event)" onmousedown="activateNOS(event)">NOS</div>
</div>

<div id="pauseScreen" class="screen-overlay">
    <h1>PAUSE</h1>
    <p>Le jeu est en pause.</p>
    <button class="action-btn" onclick="togglePause()">REPRENDRE</button>
    <button class="action-btn secondary-btn" onclick="window.location.reload()">QUITTER (MENU)</button>
</div>

<div id="titleScreen" class="screen-overlay" style="display:flex; z-index:200; background: #111;">
    <h1 style="font-size:50px; margin-bottom:10px;">LES DRIVERS<br>LYONNAIS</h1>
    <p style="color:#00ffff; letter-spacing:4px; margin-bottom:40px;">ULTIMATE EDITION</p>
    
    <div style="display:flex; gap:20px; flex-direction:column; width:80%; max-width:400px;">
        <button class="action-btn" onclick="chooseMode('CAREER')" style="background: linear-gradient(45deg, #ff00ff, #550055); border-color:#ff00ff;">
            üè¢ MODE CARRI√àRE<br><span style="font-size:12px; color:#ebb;">G√àRE TON GARAGE & AM√âLIORE TES CAISSES</span>
        </button>
        
        <button class="action-btn" onclick="chooseMode('FREE')" style="background: linear-gradient(45deg, #00ffff, #005555); border-color:#00ffff;">
            üèÅ MODE LIBRE<br><span style="font-size:12px; color:#cee;">TOUT D√âBLOQU√â & FUN IMM√âDIAT</span>
        </button>
    </div>
</div>

<div id="menuScreen" class="screen-overlay">
    <h1 id="menuTitle">GARAGE</h1>
    
    <div id="careerPanel" style="width:90%; background:rgba(0,0,0,0.6); border:1px solid #444; padding:10px; border-radius:8px; margin-bottom:10px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <div style="font-size:14px; color:#aaa;">RANG PILOTE</div>
            <div id="rankDisplay" style="font-weight:bold; color:#00ffff;">D√âBUTANT (Niv 1)</div>
        </div>
        <div style="width:100%; height:6px; background:#333; border-radius:3px;">
            <div id="xpBar" style="width:0%; height:100%; background:linear-gradient(90deg, #ff00ff, #00ffff);"></div>
        </div>
        <hr style="border:0; border-top:1px solid #555; margin:8px 0;">
        <div style="font-size:14px; color:#ffd700; font-weight:bold;">üìã CONTRAT DU JOUR</div>
        <div id="missionText" style="font-size:12px; color:#fff; margin-top:3px;">Ramasser 50 pi√®ces</div>
        <div id="missionReward" style="font-size:12px; color:#0f0; text-align:right;">Prime: +500 ü¶Å</div>
    </div>
    
    <div id="garage">
        <button class="nav-btn" onclick="changeCar(-1)">&#10094;</button>
        <div class="car-box"><canvas id="previewCanvas"></canvas></div>
        <button class="nav-btn" onclick="changeCar(1)">&#10095;</button>
    </div>
    
    <div id="carName">NOM</div>
    
    <div id="carStats">
        <span style="color:#aaa;font-weight:bold;">VITESSE :</span> <span id="statSpeed" class="stat-bar"></span><br>
        <span style="color:#aaa;font-weight:bold;">MANIABILIT√â :</span> <span id="statHand" class="stat-bar"></span>
    </div>
    
    <div id="careerInfoUI" style="margin-bottom:10px; color:#ffd700; font-size:20px; font-weight:bold; font-family:'Courier New'; text-shadow: 0 0 5px black; display:none;">
        SOLDE : <span id="globalCoinsDisplay">0</span> ü¶Å
    </div>

    <div id="lockInfo" style="display:none; color: #ff3333; font-weight: bold; margin-bottom: 5px;">üîí V√âHICULE VERROUILL√â</div>

    <button id="startBtn" class="action-btn" onclick="startGame()">D√âMARRER</button>
    <button id="buyCarBtn" class="action-btn" style="display:none; background-color:#00aa00;" onclick="buyCurrentCar()">ACHETER</button>
    
    <button id="upgradeCarBtn" class="action-btn secondary-btn" style="display:none; border-color:#ffd700; color:#ffd700;" onclick="openCarUpgradeMenu()">
        üõ†Ô∏è AM√âLIORER CE V√âHICULE
    </button>
    
    <button class="action-btn secondary-btn" onclick="showLeaderboard()">üèÜ SCORES (LOOTLOCKER)</button>
    <button class="action-btn secondary-btn" onclick="showInstructions()">‚ÑπÔ∏è INSTRUCTIONS</button>
    <button class="action-btn secondary-btn" style="border-color:#ff00ff; color:#ff00ff;" onclick="showVipLogin()">üîê CONNEXION VIP</button>
    <button class="action-btn secondary-btn" onclick="backToTitle()">RETOUR TITRE</button>
</div>

<div id="careerScreen" class="screen-overlay">
    <h1 style="color:#ffd700;">ATELIER</h1>
    <h3 id="upgradeCarName" style="color:#fff; margin-top:0;">NOM DU BOLIDE</h3>
    <div id="walletDisplay" style="font-size:20px; color:#ffd700; margin-bottom:10px;">üí∞ SOLDE: 0</div>

    <div id="upgradesGrid"></div>

    <button class="action-btn secondary-btn" onclick="closeCareerMenu()">RETOUR GARAGE</button>
</div>

<div id="vipLoginScreen" class="screen-overlay">
    <h1>ACC√àS VIP (Mot de Passe)</h1>
    <p>Entrez le mot de passe secret re√ßu lors de l'inscription par mail sur le canal LESDRIVERS.</p>
    <input type="password" id="vipPasswordInput" placeholder="Mot de passe">
    
    <button id="loginBtn" onclick="loginVipUser()">SE CONNECTER</button>
    
    <p id="vipError" style="color:red; display:none; margin-top:10px;">Mot de passe incorrect.</p>
    <p id="vipSuccess" style="color:#00ff00; display:none; margin-top:10px;"></p>

    <button class="action-btn secondary-btn" onclick="closeVipLogin()">RETOUR</button>
</div>

<div id="vipMenuScreen" class="screen-overlay">
    <h1 style="color:#ffff00; text-shadow:0 0 10px orange;">GARAGE VIP</h1>
    <p>CHOISIS TON MODE DE JEU</p>
    <div id="vipGrid">
        </div>
    <button class="action-btn secondary-btn" onclick="closeVipMenu()">RETOUR</button>
</div>

<div id="instructionsScreen" class="screen-overlay">
    <h1>INSTRUCTIONS</h1>
    <div class="instruction-section">
        <h3>BUT DU JEU</h3>
        <p>Atteignez la plus grande distance possible. Ramassez des ü¶Å pour am√©liorer votre voiture !</p>
    </div>
    <div class="instruction-section">
        <h3>CONTROLES (TACTILE)</h3>
        <p>‚Ä¢ **TAP GAUCHE/DROIT** : Se d√©placer.</p>
        <p>‚Ä¢ **BOUTON FREIN** : Ralentir (Slow Motion).</p>
        <p>‚Ä¢ **BOUTON NOS** : Action sp√©ciale.</p>
    </div>
    <div class="instruction-section">
        <h3>CONTROLES (PC)</h3>
        <p>‚Ä¢ **FL√àCHES** : Se d√©placer.</p>
        <p>‚Ä¢ **A** : Freiner.</p>
        <p>‚Ä¢ **Z** : NOS / Action Sp√©ciale.</p>
    </div>
    <button class="action-btn" onclick="closeInstructions()">RETOUR AU MENU</button>
</div>

<div id="leaderboardScreen" class="screen-overlay">
    <h1>TOP PILOTES</h1>
    <div class="leaderboard-content">
        <table id="scoreTable">
            <thead><tr><th>#</th><th>NOM</th><th>DIST</th></tr></thead>
            <tbody id="scoreList"></tbody>
        </table>
        <img id="pilotMascot" src="https://i.ibb.co/cSHRYhPV/file-00000000b0dc71f4962ea895363a14af-2.png" alt="Pilote">
    </div>
    <button class="action-btn" onclick="closeLeaderboard()">RETOUR</button>
</div>

<div id="gameOverScreen" class="screen-overlay">
    <h1 id="gameOverTitle">T'A BROYER L'AUTO !</h1>
    
    <div class="final-score-line">DIST: <span id="goDistance" class="final-score-value">0.0 km</span></div>
    <div class="final-score-line">PHOTOS: <span id="goBonus" class="final-score-value">0</span></div>
    <div class="final-score-line" style="color:#ffd700;">GAIN: <span id="goCoins" class="final-score-value" style="color:#ffd700;">+0 ü¶Å</span></div>
    
    <div style="width:50%; height:1px; background:#555; margin: 10px 0;"></div>

    <div class="final-score-line">SCORE: <span id="goFinalScore" class="final-score-value" style="font-size:22px;">0.00</span></div>
    
    <div id="highScoreZone">
        <p style="color:#00ff00; font-weight:bold; margin-bottom:5px; font-size:14px;">üéâ NOUVEAU RECORD !</p>
        <input type="text" id="nameInput" placeholder="TON NOM" maxlength="10">
        <button id="submitBtn" onclick="submitScore()">ENVOYER</button>
    </div>

    <button class="action-btn" onclick="restartGame()" style="margin-top:15px; padding: 10px 30px;">üîÑ REJOUER</button>
    <div style="display:flex; gap:10px; width:95%; max-width:400px; justify-content:center; margin-top:5px;">
        <button class="action-btn secondary-btn" style="flex:1; padding: 8px;" onclick="backToGarage()">üöó GARAGE</button>
        <button class="action-btn secondary-btn" style="flex:1; padding: 8px;" onclick="backToTitle()">üè† MENU</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const ROTATION_ANGLE = 0; 
    const CAR_W = 45; 
    const CAR_H = 95;
    const BG_URL = "https://i.ibb.co/B2zdFmwb/1765327821263.jpg";
    const TRUCK_URL = "https://i.ibb.co/hFm7Q136/1765393224904.png";
    const SPOTTERS_URL = "https://i.ibb.co/tTLS0PyH/Gemini-Generated-Image-t1crwt1crwt1crwt-1.png";
    const BRINKS_URL = "https://i.ibb.co/FqdPbVV2/Design-sans-titre.png"; 

    const TRUCK_W_FIXED = 240; 
    const TRUCK_H_FIXED = 60;  
    const RADAR_SPEED_LIMIT = 70; 
    
    const BRAKE_DURATION_MS = 3000; 
    const BRAKE_COOLDOWN_MS = 2000; 

    // --- CONFIGURATION LOOTLOCKER ---
    const LL_GAME_ID = "101303"; 
    const LL_API_KEY = "dev_6e2e629f217946e39970b94134c58686";
    const LL_LEADERBOARD_ID = "32340"; 
    let llSessionToken = "";

    // --- CONFIGURATION VIP ---
    const VIP_PASSWORD = "LYON"; 

    // --- SYSTEME SAUVEGARDE & CARRIERE V5 ---
    let currentGameMode = 'CAREER'; // 'CAREER' ou 'FREE'
    
    let savedData = {
        coins: 0,
        xp: 0,           // Exp√©rience totale
        rankLevel: 1,    // Niveau actuel
        garage: {},
        currentMission: null // La mission en cours
    };

    const UPGRADE_COSTS = [100, 300, 600, 1200, 2500]; // Co√ªts progressifs
    const MAX_LEVEL = 5;
    
    // --- NIVEAUX PLUS DIFFICILES ---
    const XP_LEVELS = [0, 2500, 7500, 15000, 25000, 40000, 60000, 100000];
    const RANK_TITLES = ["AUTO-√âCOLE", "TOURISTE", "D√âBUTANT", "CHAUFFARD", "PILOTE", "GOFATEUR", "L√âGENDE", "DIEU DU BITUME"];

    // Initialise une voiture dans la sauvegarde si elle n'existe pas encore
    function initCarData(index) {
        if (!savedData.garage[index]) {
            savedData.garage[index] = {
                owned: (index === 0), // La premi√®re (Peugeot) est offerte
                upgrades: { speed: 0, handling: 0, magnet: 0, shield: 0 }
            };
        }
    }

    function loadSaveData() {
        const data = localStorage.getItem('driversLyonnaisSave_v5');
        if(data) {
            savedData = JSON.parse(data);
        }
        // V√©rification d'int√©grit√©
        carsData.forEach((_, index) => initCarData(index));
        // G√©n√©rer une mission si aucune n'existe
        if (!savedData.currentMission) generateNewMission();

        updateGlobalCoinsUI();
    }
    
    function saveGameData() {
        localStorage.setItem('driversLyonnaisSave_v5', JSON.stringify(savedData));
        updateGlobalCoinsUI();
    }

    function updateGlobalCoinsUI() {
        const el = document.getElementById('globalCoinsDisplay');
        if(el) el.innerText = savedData.coins;
        const walletEl = document.getElementById('walletDisplay');
        if(walletEl) walletEl.innerText = "üí∞ SOLDE: " + savedData.coins + " ü¶Å";
    }

    const ENEMY_SPRITE_URLS = [
        "https://i.ibb.co/gbGhCsq3/1765396878722.png",
        "https://i.ibb.co/0yhcjXy5/1765397118940.png",
        "https://i.ibb.co/QvdHHpdk/1765397118940-1.png",
        "https://i.ibb.co/XkMHYVc5/1765397118940-2.png",
        "https://i.ibb.co/whXpcKD7/1765397118940-3.png",
        "https://i.ibb.co/W4DPrBR5/1765397118940-4.png",
        "https://i.ibb.co/PG2LqnSX/1765397132500-4.png",
        "https://i.ibb.co/G41PXzjB/1765397132500-5.png",
        "https://i.ibb.co/V0FRB8VY/1765397132500-1.png"
    ];

    // --- PRIX AUGMENT√âS & NOUVELLE VOITURE ---
    let carsData = [
        { name: "PEUGEOT 205 T16", src: "https://i.ibb.co/v6QhzC0v/1765324109186-ezgif-com-png-to-jpg-converter.png", speedFactor: 10, handling: 0.9, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", price: 0 },
        { name: "RENAULT 5 TURBO", src: "https://i.ibb.co/gLpfpKx5/1765324109186-ezgif-com-crop-4.png", speedFactor: 9, handling: 1.2, descSpeed: "‚ñÆ‚ñÆ‚ñØ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ", price: 1500 },
        { name: "MERCEDES SL",     src: "https://i.ibb.co/nqNZ1h26/1765324109186-ezgif-com-crop.png", speedFactor: 11, handling: 0.7, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñØ‚ñØ‚ñØ", price: 3000 },
        { name: "AUDI QUATTRO",    src: "https://i.ibb.co/4Z5kVGxD/1765324109186-ezgif-com-crop-1.png", speedFactor: 11, handling: 1.0, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ", price: 5000 },
        { name: "BMW E30",         src: "https://i.ibb.co/ch46FTBY/1765324109186-ezgif-com-crop-3.png", speedFactor: 12, handling: 0.8, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", price: 8000 },
        { name: "SL D'ALEX",       src: "https://i.ibb.co/sdL9DB3b/1765333831273-1.png", speedFactor: 13, handling: 0.8, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", price: 12000 },
        { name: "BOXSTER S 986",   src: "https://i.ibb.co/xtsYpCK5/1765333831273-2-1.png", speedFactor: 13, handling: 1.2, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ", price: 18000 },
        { name: "PORSCHE 911",     src: "https://i.ibb.co/qfJh4D1/1765324109186-ezgif-com-crop-2.png", speedFactor: 14, handling: 1.1, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", price: 25000 },
        { name: "FERRARI TESTA",   src: "https://i.ibb.co/6RY19XVR/1765336708745.png", speedFactor: 14, handling: 1.1, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", price: 40000 },
        { name: "ELEANOR GT500",   src: "https://i.ibb.co/pBSQNMM3/thumbnail-1765469042532.png", speedFactor: 15, handling: 0.85, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", price: 65000 },
        
        // --- IMAGES MISES √Ä JOUR ICI ---
        { name: "PORSCHE GT3 RS",  src: "https://i.ibb.co/hRVGqjfb/1765670736463-2.png", speedFactor: 15.5, handling: 1.15, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", price: 85000 },
        { name: "FERRARI F40",     src: "https://i.ibb.co/CsWqW1BN/1765670744086.png", speedFactor: 16, handling: 1.05, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", price: 150000 },
        { name: "FOURMI ACROMY",   src: "https://i.ibb.co/3Z8zLGX/1765462278497.png", speedFactor: 5, handling: 1.5, descSpeed: "‚ñÆ‚ñØ‚ñØ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+", price: 200000 },
        { name: "MERCEDES GTR GT1",src: "https://i.ibb.co/ycMMtnb7/1765670741136.png", speedFactor: 17, handling: 1.4, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ++", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+", price: 300000 },
        { name: "RENAULT ESPACE F1", src: "https://i.ibb.co/fGp0q5ks/1765670747135.png", speedFactor: 17.5, handling: 1.35, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ++", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+", price: 450000 },
        { name: "SUZUKI ESCUDO",   src: "https://i.ibb.co/N2rg94NS/1765670753509.png", speedFactor: 19, handling: 1.6, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+++", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ++", price: 1000000 }
    ];

    const vipModes = [
        { id: "POLICE", name: "BAC (POLICE)", desc: "NOS ILLIMIT√â", carName: "M√âGANE R.S. BAC", src: "https://i.ibb.co/4wPy50J0/1000027506.png", speed: 16, hand: 1.2, actionText: "NOS ‚àû" },
        { id: "BULLDOZER", name: "BULLDOZER", desc: "D√âTRUIS LES VOITURES", carName: "HUMMER H2", src: "https://i.ibb.co/23dzfm0K/1000027510.png", speed: 12, hand: 0.6, actionText: "SMASH" },
        { id: "SPECTRE", name: "SPECTRE", desc: "PHASE (INTANGIBLE)", carName: "DELOREAN", src: "https://i.ibb.co/LDY8Fq9g/1000027502.png", speed: 14, hand: 1.0, actionText: "PHASE" },
        { id: "GOLDEN", name: "GOLDEN BOY", desc: "SCORE X2", carName: "CYBERPUNK", src: "https://i.ibb.co/QFDwsVZf/1000027503.png", speed: 18, hand: 1.1, actionText: "SCORE X2" },
        { id: "BOND", name: "007", desc: "TIRE DES MISSILES", carName: "ASTON MARTIN", src: "https://i.ibb.co/dsPXPDST/1000027505.png", speed: 15, hand: 1.0, actionText: "FEU" },
        { id: "JUMP", name: "K-2000", desc: "SAUTE PAR DESSUS", carName: "K.I.T.T.", src: "https://i.ibb.co/0v5GsRq/1000027504.png", speed: 16, hand: 1.2, actionText: "SAUT" },
        { id: "MICRO", name: "MICRO", desc: "TOUT PETIT (HITBOX)", carName: "MINI COOPER", src: "https://i.ibb.co/N2TRNfKb/1000027507.png", speed: 13, hand: 1.6, actionText: "NOS" },
        { id: "RETRO", name: "RETRO", desc: "10 VIES AU D√âPART", carName: "FERRARI OUTRUN", src: "https://i.ibb.co/jZJFksHD/1000027508.png", speed: 14, hand: 1.0, actionText: "10 VIES" }
    ];

    let currentVipMode = null;

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const distEl = document.getElementById('distVal');
    const heartsEl = document.getElementById('hearts');
    const timerEl = document.getElementById('timer');
    const photoScoreEl = document.getElementById('photoScore');
    const menuScreen = document.getElementById('menuScreen');
    const leaderboardScreen = document.getElementById('leaderboardScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const instructionsScreen = document.getElementById('instructionsScreen');
    const vipLoginScreen = document.getElementById('vipLoginScreen');
    const vipMenuScreen = document.getElementById('vipMenuScreen');
    const careerScreen = document.getElementById('careerScreen');
    const pauseScreen = document.getElementById('pauseScreen');
    const pauseBtn = document.getElementById('pause-btn');
    const vipGrid = document.getElementById('vipGrid');
    const speedValEl = document.getElementById('speedVal');
    const goDistanceEl = document.getElementById('goDistance');
    const goBonusEl = document.getElementById('goBonus');
    const goFinalScoreEl = document.getElementById('goFinalScore');
    const goCoinsEl = document.getElementById('goCoins');
    const nameInputEl = document.getElementById('nameInput');
    const goTitleEl = document.getElementById('gameOverTitle');
    const carNameEl = document.getElementById('carName');
    const pCanvas = document.getElementById('previewCanvas');
    const pCtx = pCanvas.getContext('2d');
    const statSpeedEl = document.getElementById('statSpeed');
    const statHandEl = document.getElementById('statHand');
    const nosContainer = document.getElementById('nos-container');
    const nosBarFill = document.getElementById('nos-bar-fill');
    const nosBtn = document.getElementById('nos-btn');
    const brakeBtn = document.getElementById('brake-btn');
    const alertMsg = document.getElementById('alert-msg');
    const photoGradeMsg = document.getElementById('photo-grade');
    const flashOverlay = document.getElementById('flash-overlay');
    const scoreList = document.getElementById('scoreList');
    const highScoreZone = document.getElementById('highScoreZone');
    const submitBtn = document.getElementById('submitBtn');
    const vipPasswordInputEl = document.getElementById('vipPasswordInput'); 
    const vipErrorEl = document.getElementById('vipError');
    const vipSuccessEl = document.getElementById('vipSuccess');
    const coinsValEl = document.getElementById('coinsVal');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    pCanvas.width = 140; pCanvas.height = 180;

    ctx.imageSmoothingEnabled = false;
    pCtx.imageSmoothingEnabled = false;

    const bgImage = new Image(); bgImage.src = BG_URL;
    const truckImage = new Image(); truckImage.src = TRUCK_URL;
    const spottersImage = new Image(); spottersImage.src = SPOTTERS_URL;
    const brinksImage = new Image(); brinksImage.src = BRINKS_URL;
    
    const enemyImages = ENEMY_SPRITE_URLS.map(url => {
        const img = new Image(); img.src = url; return img;
    });
    
    let currentCarIndex = 0;
    const loadedImages = [];
    
    function loadCarImages() {
        carsData.forEach((data, index) => {
            const img = new Image(); img.src = data.src;
            img.onload = () => { if(index === currentCarIndex && !currentVipMode) updateMenu(); };
            loadedImages[index] = img;
        });
        vipModes.forEach(mode => {
            const img = new Image(); img.src = mode.src;
            img.onload = () => { if(currentVipMode && currentVipMode.id === mode.id) updateMenu(); };
            mode.imgObj = img;
        });
    }
    loadCarImages();

    function drawRotated(context, img, x, y, width, height, angleDegrees, opacity = 1) {
        if (!img.complete) {
            context.save(); context.fillStyle = "red"; context.fillRect(x, y, width, height); context.restore(); return;
        }
        context.save();
        context.globalAlpha = opacity;
        context.translate(x + width / 2, y + height / 2);
        context.rotate(angleDegrees * Math.PI / 180);
        context.drawImage(img, -width / 2, -height / 2, width, height);
        context.restore();
    }
    
    // --- GESTION NOUVEAUX MENUS ---
    function chooseMode(mode) {
        currentGameMode = mode;
        document.getElementById('titleScreen').style.display = 'none';
        menuScreen.style.display = 'flex';
        
        // Mise √† jour de l'interface selon le mode
        if (mode === 'FREE') {
            document.getElementById('menuTitle').innerText = "MODE LIBRE (Tout d√©bloqu√©)";
            document.getElementById('careerInfoUI').style.display = 'none';
            document.getElementById('upgradeCarBtn').style.display = 'none';
        } else {
            document.getElementById('menuTitle').innerText = "GARAGE CARRI√àRE";
            document.getElementById('careerInfoUI').style.display = 'block';
        }
        updateMenu(); // Rafraichir l'affichage des voitures
    }

    function backToTitle() {
        menuScreen.style.display = 'none';
        gameOverScreen.style.display = 'none';
        careerScreen.style.display = 'none';
        leaderboardScreen.style.display = 'none';
        
        document.getElementById('brake-btn').style.display = 'none';
        document.getElementById('nos-container').style.display = 'none';
        document.getElementById('pause-btn').style.display = 'none';

        document.getElementById('titleScreen').style.display = 'flex';
    }

    // --- LOGIQUE CARRI√àRE AVANC√âE ---
    function generateNewMission() {
        const types = ['DIST', 'COINS'];
        const type = types[Math.floor(Math.random() * types.length)];
        let target, reward, text;

        // Difficult√© bas√©e sur le niveau de rang
        let multi = Math.max(1, savedData.rankLevel * 0.5);

        if (type === 'DIST') {
            target = Math.floor(2 + (Math.random() * 3 * multi)); 
            reward = target * 100;
            text = `Parcourir ${target} km en une course`;
        } else {
            target = Math.floor(20 + (Math.random() * 50 * multi)); 
            reward = target * 10;
            text = `R√©colter ${target} Lions d'Or`;
        }
        savedData.currentMission = { type: type, target: target, reward: reward, text: text, done: false };
        saveGameData();
    }

    function checkRankUp() {
        let nextLevelXP = XP_LEVELS[savedData.rankLevel];
        if (!nextLevelXP) return; 

        if (savedData.xp >= nextLevelXP) {
            savedData.rankLevel++;
            let bonus = 1000 * savedData.rankLevel;
            savedData.coins += bonus;
            alert(`üéâ NIVEAU SUP√âRIEUR !\nTu es maintenant : ${RANK_TITLES[savedData.rankLevel-1]}\nBonus : +${bonus} ü¶Å`);
            saveGameData();
        }
    }

    function updateMenu() {
        // VIP (CHEAT MODE)
        if (currentVipMode) {
             const mode = currentVipMode;
             carNameEl.innerText = mode.carName + " (" + mode.id + ")";
             carNameEl.style.color = "#ffff00"; carNameEl.style.textShadow = "0 0 10px orange";
             statSpeedEl.innerText = mode.descSpeed || "N/A";
             statHandEl.innerText = mode.descHand || "N/A";
             pCtx.clearRect(0, 0, pCanvas.width, pCtx.canvas.height); 
             const previewW = 45; const previewH = 95;
             drawRotated(pCtx, mode.imgObj, (pCanvas.width-previewW)/2, (pCanvas.height-previewH)/2, previewW, previewH, ROTATION_ANGLE);
             
             document.getElementById('startBtn').style.display = 'block';
             document.getElementById('buyCarBtn').style.display = 'none';
             document.getElementById('upgradeCarBtn').style.display = 'none';
             document.getElementById('lockInfo').style.display = 'none';
             return;
        }

        const car = carsData[currentCarIndex];
        carNameEl.innerText = car.name;
        
        const startBtn = document.getElementById('startBtn');
        const buyCarBtn = document.getElementById('buyCarBtn');
        const upgradeBtn = document.getElementById('upgradeCarBtn');
        const lockInfo = document.getElementById('lockInfo');
        const careerPanel = document.getElementById('careerPanel');
        
        // --- LOGIQUE SELON LE MODE ---
        let isOwned = false;
        
        if (currentGameMode === 'FREE') {
            isOwned = true;
            statSpeedEl.innerText = car.descSpeed;
            statHandEl.innerText = car.descHand;
            careerPanel.style.display = 'none';
        } else {
            // Mode Carri√®re
            initCarData(currentCarIndex);
            const carSave = savedData.garage[currentCarIndex];
            isOwned = carSave.owned;
            
            let speedBonus = "+".repeat(carSave.upgrades.speed);
            let handBonus = "+".repeat(carSave.upgrades.handling);
            statSpeedEl.innerHTML = car.descSpeed + " <span style='color:#0f0'>"+speedBonus+"</span>";
            statHandEl.innerHTML = car.descHand + " <span style='color:#0f0'>"+handBonus+"</span>";

            careerPanel.style.display = 'block';
            let rankIdx = Math.min(savedData.rankLevel - 1, RANK_TITLES.length - 1);
            let nextXP = XP_LEVELS[savedData.rankLevel] || 999999;
            let prevXP = XP_LEVELS[savedData.rankLevel - 1] || 0;
            let progress = 100;
            if (XP_LEVELS[savedData.rankLevel]) {
                progress = ((savedData.xp - prevXP) / (nextXP - prevXP)) * 100;
            }
            document.getElementById('rankDisplay').innerText = `${RANK_TITLES[rankIdx]} (${savedData.rankLevel})`;
            document.getElementById('xpBar').style.width = `${progress}%`;
            
            let mission = savedData.currentMission;
            if(mission) {
                document.getElementById('missionText').innerText = mission.text;
                document.getElementById('missionReward').innerText = `Prime: +${mission.reward} ü¶Å`;
            }
        }

        pCtx.clearRect(0, 0, pCanvas.width, pCtx.canvas.height);
        const previewW = 45; const previewH = 95;
        
        if (isOwned) {
            carNameEl.style.color = "#00ffff"; carNameEl.style.textShadow = "2px 2px 0px #ff00ff";
            startBtn.style.display = "block";
            buyCarBtn.style.display = "none";
            lockInfo.style.display = "none";
            upgradeBtn.style.display = (currentGameMode === 'CAREER') ? "block" : "none";
            
            if (loadedImages[currentCarIndex]) drawRotated(pCtx, loadedImages[currentCarIndex], (pCanvas.width-previewW)/2, (pCanvas.height-previewH)/2, previewW, previewH, ROTATION_ANGLE, 1);
        } else {
            carNameEl.style.color = "#888"; carNameEl.style.textShadow = "none";
            startBtn.style.display = "none";
            upgradeBtn.style.display = "none";
            lockInfo.style.display = "block";
            
            buyCarBtn.style.display = "block";
            buyCarBtn.innerText = "ACHETER (" + (car.price || 500) + " ü¶Å)";

            if (loadedImages[currentCarIndex]) drawRotated(pCtx, loadedImages[currentCarIndex], (pCanvas.width-previewW)/2, (pCanvas.height-previewH)/2, previewW, previewH, ROTATION_ANGLE, 0.4);
            pCtx.font = "40px Arial"; pCtx.fillStyle = "white"; pCtx.textAlign = "center"; pCtx.fillText("üîí", pCanvas.width/2, pCanvas.height/2 + 10);
        }
    }
    
    window.buyCurrentCar = function() {
        const car = carsData[currentCarIndex];
        const cost = car.price || 500;
        
        if (savedData.coins >= cost) {
            savedData.coins -= cost;
            savedData.garage[currentCarIndex].owned = true;
            saveGameData();
            alert("V√âHICULE ACHET√â !");
            updateMenu();
        } else {
            alert("Pas assez de Lions d'Or !");
        }
    };

    window.changeCar = function(dir) {
        currentVipMode = null; 
        currentCarIndex += dir;
        if(currentCarIndex < 0) currentCarIndex = carsData.length - 1;
        if(currentCarIndex >= carsData.length) currentCarIndex = 0;
        updateMenu();
    };

    window.showInstructions = function() { menuScreen.style.display = 'none'; instructionsScreen.style.display = 'flex'; }
    window.closeInstructions = function() { instructionsScreen.style.display = 'none'; menuScreen.style.display = 'flex'; }

    // --- GESTION MENU ATELIER INDIVIDUEL ---
    window.openCarUpgradeMenu = function() {
        menuScreen.style.display = 'none';
        careerScreen.style.display = 'flex';
        const car = carsData[currentCarIndex];
        document.getElementById('upgradeCarName').innerText = "AM√âLIORATION : " + car.name;
        renderUpgrades();
    }
    window.closeCareerMenu = function() {
        careerScreen.style.display = 'none';
        menuScreen.style.display = 'flex';
        updateMenu();
    }

    function renderUpgrades() {
        const grid = document.getElementById('upgradesGrid');
        grid.innerHTML = "";
        
        const carSave = savedData.garage[currentCarIndex];
        
        const upgradeTypes = [
            { id: 'speed', name: 'MOTEUR', desc: 'Vitesse Max' },
            { id: 'handling', name: 'PNEUS', desc: 'Maniabilit√©' },
            { id: 'magnet', name: 'AIMANT', desc: 'Port√©e Lions' },
            { id: 'shield', name: 'CARROSSERIE', desc: 'Invuln√©rabilit√©' }
        ];

        upgradeTypes.forEach(type => {
            const level = carSave.upgrades[type.id];
            const isMax = level >= MAX_LEVEL;
            const cost = isMax ? "MAX" : UPGRADE_COSTS[level];

            let dots = ""; for(let i=0; i<MAX_LEVEL; i++) dots += (i < level) ? "<span style='color:#0f0'>‚óè</span>" : "<span style='color:#555'>‚óè</span>";

            let btnHtml = isMax 
                ? `<button class="buy-btn" disabled>MAX</button>`
                : `<button class="buy-btn" onclick="buyCarUpgrade('${type.id}')">${cost} ü¶Å</button>`;

            let card = document.createElement('div');
            card.className = 'upgrade-card';
            let icon = type.id === 'speed' ? '‚ö°' : type.id === 'handling' ? 'üõû' : type.id === 'magnet' ? 'üß≤' : 'üõ°Ô∏è';
            card.innerHTML = `<h4 style="font-size:24px;">${icon}</h4><h4 style="color:#00ffff">${type.name}</h4><div class="level-dots" style="font-size:16px;">${dots}</div><span style="font-size:10px; color:#aaa;">${type.desc}</span><div style="margin-top:auto; width:100%;">${btnHtml}</div>`;
            grid.appendChild(card);
        });
        updateGlobalCoinsUI();
    }

    window.buyCarUpgrade = function(type) {
        const carSave = savedData.garage[currentCarIndex];
        const level = carSave.upgrades[type];
        if (level >= MAX_LEVEL) return;
        
        const cost = UPGRADE_COSTS[level];
        if (savedData.coins >= cost) {
            savedData.coins -= cost;
            carSave.upgrades[type]++;
            saveGameData();
            renderUpgrades();
        } else {
            alert("Pas assez de Lions d'Or !");
        }
    }

    window.showVipLogin = function() { menuScreen.style.display = 'none'; vipLoginScreen.style.display = 'flex'; vipErrorEl.style.display = 'none'; vipSuccessEl.style.display = 'none'; vipPasswordInputEl.value = ''; }
    window.closeVipLogin = function() { vipLoginScreen.style.display = 'none'; menuScreen.style.display = 'flex'; }

    window.loginVipUser = function() {
        const password = vipPasswordInputEl.value.toUpperCase().trim();
        vipErrorEl.style.display = 'none'; vipSuccessEl.style.display = 'none';
        if(password.length === 0) { vipErrorEl.innerText = "Veuillez entrer le mot de passe."; vipErrorEl.style.display = 'block'; return; }
        if (password === VIP_PASSWORD) {
            alert("Connexion VIP r√©ussie !");
            llSessionToken = `VIP_SESSION_${Math.random().toString(36).substring(2, 9)}`; 
            showVipMenu();
            return;
        }
        vipErrorEl.innerText = "Mot de passe incorrect."; vipErrorEl.style.display = 'block';
    }

    function showVipMenu() {
        vipLoginScreen.style.display = 'none'; vipMenuScreen.style.display = 'flex';
        currentVipMode = null;
        vipGrid.innerHTML = "";
        vipModes.forEach(mode => {
            let card = document.createElement("div");
            card.className = "vip-card";
            card.innerHTML = `<img src="${mode.src}" style="width:50px; height:50px; object-fit:contain; filter: drop-shadow(0 0 5px #ff00ff);"><h4 style="color:#ffff00">${mode.name}</h4><span>${mode.desc}</span>`;
            card.onclick = () => selectVipMode(mode);
            vipGrid.appendChild(card);
        });
    }

    window.closeVipMenu = function() { vipMenuScreen.style.display = 'none'; menuScreen.style.display = 'flex'; }

    function selectVipMode(mode) {
        currentVipMode = mode;
        updateMenu();
        alert("MODE " + mode.name + " S√âLECTIONN√â !");
        vipMenuScreen.style.display = 'none';
        menuScreen.style.display = 'flex';
    }

    // --- LOOTLOCKER ---
    async function initLootLocker() {
        try { const response = await fetch('https://api.lootlocker.io/game/v2/session/guest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ game_key: LL_API_KEY, game_version: "1.0.0" }) });
            const data = await response.json();
            if(data.session_token) llSessionToken = data.session_token;
        } catch(e) { console.error("Err LL", e); }
    }
    initLootLocker();

    async function getScores() {
        if(!llSessionToken) { await initLootLocker(); } 
        if(!llSessionToken || llSessionToken.startsWith("VIP_SESSION_")) return []; 
        try { const response = await fetch(`https://api.lootlocker.io/game/leaderboards/${LL_LEADERBOARD_ID}/list?count=10`, { method: 'GET', headers: { 'x-session-token': llSessionToken, 'Content-Type': 'application/json' } }); const data = await response.json(); if(data && data.items) return data.items.map(i => ({ name: i.metadata || "Pilote", score: i.score })); return []; } catch (e) { return []; }
    }

    async function saveScore(name, dist) {
        submitBtn.innerText = "ENVOI..."; submitBtn.disabled = true;
        if(!llSessionToken) { await initLootLocker(); }
        if(!llSessionToken || llSessionToken.startsWith("VIP_SESSION_")) { submitBtn.innerText = "SCORE NON ENVOY√â (MODE VIP)"; submitBtn.disabled = false; return; }
        let cleanName = name.replace(/[^a-zA-Z0-9 ]/g, "").substring(0, 10) || "Anonyme";
        let scoreToSend = Math.floor(parseFloat(goFinalScoreEl.innerText) * 10); 
        try { await fetch(`https://api.lootlocker.io/game/leaderboards/${LL_LEADERBOARD_ID}/submit`, { method: 'POST', headers: { 'x-session-token': llSessionToken, 'Content-Type': 'application/json' }, body: JSON.stringify({ score: scoreToSend, metadata: cleanName }) }); submitBtn.innerText = "SCORE ENVOY√â !"; } catch(e) { submitBtn.innerText = "ERREUR"; submitBtn.disabled = false; }
    }

    async function showLeaderboard() {
        menuScreen.style.display = 'none'; leaderboardScreen.style.display = 'flex';
        scoreList.innerHTML = "<tr><td colspan='3'>Chargement...</td></tr>";
        let scores = await getScores(); scoreList.innerHTML = "";
        if(scores.length === 0) scoreList.innerHTML = "<tr><td colspan='3'>Classement indisponible ou vide.</td></tr>";
        else scores.forEach((s, i) => { scoreList.innerHTML += `<tr><td>#${i+1}</td><td>${s.name}</td><td>${(s.score/10).toFixed(1)} km</td></tr>`; });
    }
    window.closeLeaderboard = function() { leaderboardScreen.style.display = 'none'; menuScreen.style.display = 'flex'; };
    window.submitScore = function() { saveScore(nameInputEl.value.toUpperCase().substring(0, 10) || "ANONYME", 0); }

    // VARIABLES JEU
    let gameRunning = false;
    let isPaused = false;
    let distance = 0;
    let speed = 10;
    let targetSpeed = 10; 
    let baseSpeed = 10; 
    let handling = 0.8;
    let startTime;
    let difficultyInterval;
    let elapsedTime = 0;
    let lives = 3;
    let isInvincible = false;
    let invincibilityTimer = 0;

    let nosLevel = 0; 
    let isNosActive = false;
    let nosEndTime = 0;
    let isBraking = false;
    let brakeEndTime = 0; 
    let brakeCooldownEndTime = 0;

    let currentLevel = 1;
    let levelEvents = []; 
    let lastLevelEvents = [];
    let isWarningActive = false; 
    
    // VARIABLES EVENTS
    let isTunnelActive = false; let tunnelEndTime = 0;
    let isFogActive = false; let fogEndTime = 0;
    let isIceActive = false; let iceEndTime = 0;
    let isWorkActive = false; let workEndTime = 0;
    let isStormActive = false; let stormEndTime = 0;
    let lightningState = 0; let lightningNextStrike = 0; let lightningTimer = 0; let lightningLane = 0;
    
    // VARIABLES PHOTO
    let isPhotoActive = false; 
    let photoZoneY = -1000; 
    let photoBonusScore = 0; 
    let isPosing = false; 
    let spotterStopPointY = 0;
    let currentGrade = "B"; 
    let currentPointsObj = 0;

    // --- VARIABLES VIP SPECIFIQUES ---
    let projectiles = [];
    let isJumping = false;
    let jumpEndTime = 0;
    let hasExtraLives = false;
    let bondAmmo = 15;
    let bondOvertakeCount = 0;

    // --- VARIABLES PIECES ---
    let coinsCollected = 0;
    let gameCoins = [];
    let magnetRange = 0;
    let brinksEndTime = 0;

    let radars = [];
    let cones = [];
    let player = { x: 0, y: 0, targetX: 0, laneIndex: 1 }; 
    let obstacles = [];
    let bonuses = [];
    let roadLines = [];

    const ROAD_WIDTH_PCT = 0.50; 
    const ROAD_WIDTH = canvas.width * ROAD_WIDTH_PCT;
    const ROAD_LEFT = (canvas.width - ROAD_WIDTH) / 2; 
    const ROAD_RIGHT = ROAD_LEFT + ROAD_WIDTH;
    const LANE_WIDTH = ROAD_WIDTH / 3;

    function lerp(start, end, amt){ return (1-amt)*start+amt*end }

    // GESTION CLAVIER (PC)
    document.addEventListener('keydown', function(e) {
        if(!gameRunning || isPosing || isPaused) return;
        if(e.code === 'ArrowLeft') { if(player.laneIndex > 0) player.laneIndex--; player.targetX = getLaneX(player.laneIndex); }
        if(e.code === 'ArrowRight') { if(player.laneIndex < 2) player.laneIndex++; player.targetX = getLaneX(player.laneIndex); }
        if(e.code === 'KeyA') { triggerBrake(e); }
        if(e.key.toLowerCase() === 'z') { activateNOS(e); }
    });

    function handleTap(e) {
        if(!gameRunning || isPosing || isPaused) return;
        if(e.target.id === 'nos-btn' || e.target.parentNode.id === 'nos-container' || e.target.id === 'brake-btn' || e.target.id === 'pause-btn') return;
        e.preventDefault(); 
        let isControl = (e.target.closest('#brake-btn') || e.target.closest('#nos-container') || e.target.closest('#pause-btn'));
        if (isControl) return;
        let touchX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        let screenCenter = window.innerWidth / 2;
        if (touchX < screenCenter) { if(player.laneIndex > 0) player.laneIndex--; } 
        else { if(player.laneIndex < 2) player.laneIndex++; }
        player.targetX = getLaneX(player.laneIndex);
    }

    canvas.addEventListener('touchstart', handleTap, {passive: false});
    canvas.addEventListener('mousedown', handleTap);
    
    window.togglePause = function() {
        if(!gameRunning) return;
        isPaused = !isPaused;
        if(isPaused) { pauseScreen.style.display = 'flex'; } else { pauseScreen.style.display = 'none'; loop(); }
    };

    window.triggerBrake = function(e) { 
        if(e) { e.stopPropagation(); e.preventDefault(); }
        let now = Date.now();
        if (isBraking || now < brakeCooldownEndTime || isPaused) return;
        
        isBraking = true;
        brakeEndTime = now + BRAKE_DURATION_MS; 
        brakeBtn.classList.add('active'); 

        if (isPhotoActive && !isPosing) {
             let diff = Math.abs(photoZoneY - player.y);
             if (diff < 150) { 
                if (diff < 40) { currentGrade = "S - L√âGENDAIRE !"; currentPointsObj = 1000; } 
                else if (diff < 90) { currentGrade = "A - EXCELLENT"; currentPointsObj = 500; } 
                else { currentGrade = "B - PAS MAL"; currentPointsObj = 100; }
                startPhotoPose(); 
             }
        }
    };

    window.activateNOS = function(e) {
        if(e) { e.stopPropagation(); e.preventDefault(); }
        if(isPaused) return;
        
        if(currentVipMode && currentVipMode.id === "JUMP" && !isJumping) { isJumping = true; jumpEndTime = Date.now() + 1500; return; }
        
        if(currentVipMode && currentVipMode.id === "BOND") {
            if (bondAmmo > 0) {
                projectiles.push({x: player.x + CAR_W/2 - 5, y: player.y, w: 10, h: 20});
                bondAmmo--; nosBtn.innerText = bondAmmo;
            }
            return;
        }

        if(currentVipMode && currentVipMode.id === "SPECTRE" && nosLevel >= 100) {
            isInvincible = true; invincibilityTimer = Date.now() + 3000;
            nosLevel = 0; nosBarFill.style.width = "0%"; nosBtn.classList.remove('ready'); return;
        }

        let canActivate = (nosLevel >= 100) || (currentVipMode && currentVipMode.id === "POLICE");
        if (canActivate && !isNosActive && !isPosing) {
            isNosActive = true; 
            if(!currentVipMode || currentVipMode.id !== "POLICE") { nosLevel = 0; nosBarFill.style.width = "0%"; nosBtn.classList.remove('ready'); }
            targetSpeed = baseSpeed + 20; 
            nosEndTime = Date.now() + 5000; 
        }
    };

    function startPhotoPose() {
        isPosing = true; isInvincible = true; speed = 0; targetSpeed = 0;
        showAlert("POSEZ POUR LA PHOTO !", "#ff00ff", "black");
        let flashInterval = setInterval(() => { if(!isPosing) { clearInterval(flashInterval); return; } triggerSpotterFlash(); }, 300 + Math.random() * 500);
        setTimeout(() => { clearInterval(flashInterval); calculateAndShowPhotoScore(); }, 3000);
    }

    function calculateAndShowPhotoScore() {
        let scoreMult = (currentVipMode && currentVipMode.id === "GOLDEN") ? 2 : 1;
        let grade = currentGrade; 
        let pts = currentPointsObj * scoreMult; 
        let color = "#00ff00"; if(currentPointsObj === 500) color = "orange"; if(currentPointsObj === 100) color = "#ff3333";
        photoBonusScore += pts; photoScoreEl.innerText = photoBonusScore;
        
        // --- NOUVEAU : GAIN DE PIECES PHOTO ---
        let coinReward = 0;
        if(currentPointsObj === 1000) coinReward = 100;
        else if(currentPointsObj === 500) coinReward = 50;
        else coinReward = 10;
        
        if (currentGameMode === 'CAREER') {
            coinsCollected += coinReward;
            coinsValEl.innerText = coinsCollected;
            photoGradeMsg.innerText = grade + "\n+" + coinReward + " ü¶Å";
        } else {
            photoGradeMsg.innerText = grade;
        }
        
        photoGradeMsg.style.color = color; photoGradeMsg.style.display = "block"; 
        triggerFlash(); 
        setTimeout(() => { 
            photoGradeMsg.style.display = "none"; isPosing = false; isPhotoActive = false; targetSpeed = baseSpeed; 
            showAlert("C'EST REPARTI !", "lime", "black"); invincibilityTimer = Date.now() + 2000; 
        }, 2000);
    }
    
    function triggerSpotterFlash() {
        let flash = document.createElement('div'); flash.className = 'spotter-flash';
        flash.style.left = (Math.random() * ROAD_LEFT) + 'px'; flash.style.top = (photoZoneY + Math.random() * 300) + 'px';
        flash.style.width = (20 + Math.random()*30) + 'px'; flash.style.height = flash.style.width;
        document.body.appendChild(flash);
        flash.animate([{ opacity: 0, transform: 'scale(0.5)' }, { opacity: 1, transform: 'scale(1.5)' }, { opacity: 0, transform: 'scale(0.8)' }], { duration: 150 + Math.random()*150, easing: 'ease-out' }).onfinish = () => { flash.remove(); };
    }

    window.startGame = function() {
        menuScreen.style.display = 'none'; leaderboardScreen.style.display = 'none';
        gameOverScreen.style.display = 'none'; instructionsScreen.style.display = 'none';
        vipLoginScreen.style.display = 'none'; vipMenuScreen.style.display = 'none';
        careerScreen.style.display = 'none'; pauseScreen.style.display = 'none';
        document.getElementById('titleScreen').style.display = 'none';

        brakeBtn.style.display = 'flex'; brakeBtn.classList.remove('cooldown', 'active'); 
        nosContainer.style.display = 'flex'; 
        pauseBtn.style.display = 'block'; 

        nosLevel = 0; nosBarFill.style.width = "0%"; nosBtn.classList.remove('ready');

        // --- CALCUL DES STATS ---
        let speedBoost = 0;
        let handBoost = 0;
        let shieldBonus = 0;
        
        if (currentGameMode === 'CAREER' && !currentVipMode) {
            initCarData(currentCarIndex);
            const carSave = savedData.garage[currentCarIndex];
            speedBoost = carSave.upgrades.speed * 0.8;
            handBoost = carSave.upgrades.handling * 0.08;
            magnetRange = carSave.upgrades.magnet * 60;
            shieldBonus = carSave.upgrades.shield * 500;
        } else {
            magnetRange = 0;
        }

        if(currentVipMode) {
             baseSpeed = currentVipMode.speed;
             handling = currentVipMode.hand;
             nosBtn.innerText = currentVipMode.actionText; nosBtn.style.fontSize = "14px";
             if(currentVipMode.id === "BOND") { bondAmmo = 15; bondOvertakeCount = 0; nosBtn.classList.add('ready'); nosBarFill.style.width = "0%"; nosBtn.innerText = bondAmmo; }
             else if(currentVipMode.id === "POLICE") { nosLevel = 100; nosBarFill.style.width = "100%"; nosBtn.classList.add('ready'); nosBtn.style.opacity = '1'; }
             else if(currentVipMode.id === "RETRO") { lives = 10; hasExtraLives = true; }
             else { lives = 3; hasExtraLives = false; }
             if(["JUMP", "SPECTRE"].includes(currentVipMode.id)) { nosBtn.classList.add('ready'); nosLevel = 100; nosBarFill.style.width = "100%"; }
        } else {
             const carData = carsData[currentCarIndex];
             baseSpeed = carData.speedFactor + speedBoost;
             handling = carData.handling + handBoost;
             nosBtn.innerText = "NOS"; nosBtn.style.fontSize = "24px";
             lives = 3; hasExtraLives = false;
        }

        distance = 0; updateHearts(); isInvincible = false;
        targetSpeed = baseSpeed + (Math.random() * 0.5) - 0.25; speed = targetSpeed;
        
        coinsCollected = 0; coinsValEl.innerText = "0"; gameCoins = [];
        
        lightningState = 0; lightningNextStrike = 0; lightningTimer = 0; lightningLane = 0;
        isNosActive = false; photoBonusScore = 0; photoScoreEl.innerText = "0";
        obstacles = []; bonuses = []; roadLines = []; radars = []; cones = []; projectiles = [];
        
        isTunnelActive = false; isFogActive = false; isIceActive = false; isWorkActive = false; isStormActive = false; isPhotoActive = false;
        isWarningActive = false; isPosing = false; isPaused = false;
        isBraking = false; brakeCooldownEndTime = 0; brakeEndTime = 0;
        isJumping = false;

        currentLevel = 1; lastLevelEvents = []; pickLevelEvents(); 
        elapsedTime = 0; startTime = Date.now();
        
        player.laneIndex = 1; player.targetX = getLaneX(player.laneIndex);
        player.x = player.targetX; player.y = canvas.height - 150; 
        
        gameRunning = true;
        if(difficultyInterval) clearInterval(difficultyInterval);
        loop();

        // TIMER PI√àCES (Seulement en mode carri√®re ou si magnet actif)
        setInterval(() => {
            if(!gameRunning || isPaused || isPosing) return;
            if(Math.random() < 0.35) spawnCoin(); 
        }, 1000);

        difficultyInterval = setInterval(() => {
            if(!gameRunning || isPosing || isPaused) return;
            let levelCheck = Math.floor((Date.now() - startTime) / 45000) + 1;
            if(levelCheck > currentLevel) {
                currentLevel = levelCheck;
                let lifeMsg = "";
                if(lives < (hasExtraLives ? 10 : 3)) { lives++; updateHearts(); lifeMsg = " (+1 ‚ù§Ô∏è)"; }
                if(!isNosActive && !isBraking) { targetSpeed += 2; baseSpeed += 2; }
                showAlert("NIVEAU " + currentLevel + " !" + lifeMsg, "orange", "black");
                pickLevelEvents(); 
            }
            if(Math.random() < 0.08 && !isEventActive() && !isWarningActive) { warnAndTriggerEvent(); }
        }, 1000); 

        setInterval(() => {
            if(!gameRunning || isPosing || isPaused) return;
            if(obstacles.length >= 2) return;
            let blockedLane = -1;
            if(isWorkActive && cones.length > 0) blockedLane = cones[0].lane;
            let laneIndex = Math.floor(Math.random() * 3);
            if(laneIndex === blockedLane) return;
            let safeToSpawn = true;
            if(obstacles.length > 0) {
                 let lastObs = obstacles[obstacles.length - 1];
                 if(lastObs.y < -50) safeToSpawn = false;
                 if(Math.abs(lastObs.x - getLaneX(laneIndex)) < 10) safeToSpawn = false;
            }
            if(safeToSpawn) {
                let obsX = getLaneX(laneIndex);
                const randomSpriteIndex = Math.floor(Math.random() * enemyImages.length); 
                let enemyFactor = 0.4 + Math.random() * 0.4;
                if(currentVipMode && currentVipMode.id === "MICRO" && Math.random() > 0.5) { obsX += (Math.random() > 0.5 ? 20 : -20); }
                obstacles.push({ x: obsX, y: -150, img: enemyImages[randomSpriteIndex], factor: enemyFactor, lane: laneIndex });
            }
        }, 800); 

        setInterval(() => {
            if(!gameRunning || isPosing || isPaused) return;
            if(lives < (hasExtraLives ? 10 : 3) && Math.random() < 0.2) {
                let laneIndex = Math.floor(Math.random() * 3);
                let safe = true;
                obstacles.forEach(o => { if(Math.abs(o.x - getLaneX(laneIndex)) < 10 && o.y < 0) safe = false; });
                if(safe) bonuses.push({ x: getLaneX(laneIndex) + (CAR_W/2) - 15, y: -150, w: 30, h: 30 });
            }
        }, 3000);
        setInterval(() => { if(!gameRunning || isPosing || isPaused) return; roadLines.push({x: canvas.width/2 - 5, y: -50}); }, 150);
    };

    function spawnCoin() {
        let laneIndex = Math.floor(Math.random() * 3);
        let coinX = ROAD_LEFT + (laneIndex * LANE_WIDTH) + (LANE_WIDTH/2);
        gameCoins.push({ x: coinX, y: -50, w: 25, h: 25, collected: false });
    }

    async function gameOver(crashType = 'CRASH') {
        gameRunning = false; 
        nosContainer.style.display = 'none'; brakeBtn.style.display = 'none'; pauseBtn.style.display = 'none';
        
        const finalScore = parseFloat(distance.toFixed(1)) + (photoBonusScore / 100);
        
        // CALCUL ET SAUVEGARDE DES PI√àCES (Uniquement en mode Carri√®re)
        if (currentGameMode === 'CAREER') {
            let distCoins = Math.floor(distance);
            let totalCoins = coinsCollected + distCoins;
            
            // 1. Gain d'XP (1 km = 100 XP)
            let xpGain = Math.floor(distance * 100);
            savedData.xp += xpGain;
            
            // 2. V√©rification Mission
            let missionMsg = "";
            let mission = savedData.currentMission;
            if (mission && !mission.done) {
                let success = false;
                if (mission.type === 'DIST' && distance >= mission.target) success = true;
                if (mission.type === 'COINS' && coinsCollected >= mission.target) success = true;
                
                if (success) {
                    totalCoins += mission.reward;
                    missionMsg = `\n‚úÖ CONTRAT R√âUSSI (+${mission.reward} ü¶Å)`;
                    generateNewMission();
                }
            }

            savedData.coins += totalCoins;
            checkRankUp();
            saveGameData();
            
            goCoinsEl.innerText = "+" + totalCoins + " ü¶Å" + missionMsg;
            goCoinsEl.style.color = "#ffd700";
        } else {
            goCoinsEl.innerText = "MODE LIBRE (PAS DE GAIN)";
            goCoinsEl.style.color = "#aaa";
        }

        goDistanceEl.innerText = finalScore.toFixed(2) + " km";
        goBonusEl.innerText = photoBonusScore;
        goFinalScoreEl.innerText = finalScore.toFixed(2);
        
        nameInputEl.value = ""; highScoreZone.style.display = "none"; submitBtn.disabled = false; submitBtn.innerText = "ENVOYER";
        if (crashType === 'FLASH') { goTitleEl.innerText = "PERMIS RETIR√â ! (FLASH√â)"; goTitleEl.style.color = "#00ffff"; } 
        else { goTitleEl.innerText = "T'A BROYER L'AUTO !"; goTitleEl.style.color = "#ff0000"; }
        gameOverScreen.style.display = 'flex';

        try {
            let scores = await getScores();
            let finalScoreInt = Math.floor(finalScore * 10); 
            let isTop10 = scores.length < 10 || finalScoreInt > scores[scores.length - 1].score;
            if (isTop10) { highScoreZone.style.display = "flex"; }
        } catch (e) {}
    }

    function pickLevelEvents() {
        if(Math.random() < 0.30) { levelEvents = []; lastLevelEvents = []; showAlert("ROUTE D√âGAG√âE...", "lime", "black"); return; }
        const allEvents = ['TUNNEL', 'RADAR', 'FOG', 'ICE', 'WORK', 'STORM', 'TRUCK', 'PHOTO'];
        
        // AJOUT EXCLUSIF CARRI√àRE
        if (currentGameMode === 'CAREER') {
            allEvents.push('MONEY');
        }

        const availableEvents = allEvents.filter(e => !lastLevelEvents.includes(e));
        let count = (currentLevel === 1) ? 1 : 2;
        levelEvents = availableEvents.sort(() => 0.5 - Math.random()).slice(0, count);
        lastLevelEvents = levelEvents;
    }
    function isEventActive() { return isTunnelActive || isFogActive || isIceActive || isWorkActive || isStormActive || isPhotoActive; }
    function warnAndTriggerEvent() {
        if (levelEvents.length === 0) return;
        let eventType = levelEvents[Math.floor(Math.random() * levelEvents.length)];
        isWarningActive = true;
        let eventName = ""; let color = "white";
        if(eventType === 'TUNNEL') { eventName = "TUNNEL"; color = "yellow"; }
        else if(eventType === 'RADAR') { eventName = "ZONE RADAR"; color = "cyan"; }
        else if(eventType === 'FOG') { eventName = "BROUILLARD"; color = "#ccc"; }
        else if(eventType === 'ICE') { eventName = "VERGLAS"; color = "cyan"; }
        else if(eventType === 'WORK') { eventName = "TRAVAUX"; color = "orange"; }
        else if(eventType === 'STORM') { eventName = "ORAGE VIOLENT"; color = "purple"; }
        else if(eventType === 'TRUCK') { eventName = "CONVOI EXCEPTIONNEL"; color = "pink"; }
        else if(eventType === 'PHOTO') { eventName = "SPOTTERS ! PR√âPARE TOI"; color = "#ff00ff"; }
        
        // BRINK'S EVENT
        else if(eventType === 'MONEY') { eventName = "LA BRINK'S ARRIVE !"; color = "#ffd700"; }

        showAlert("‚ö†Ô∏è " + eventName + " DANS 3s ‚ö†Ô∏è", color, "black");
        setTimeout(() => { isWarningActive = false; if (eventType === 'STORM') { lightningNextStrike = Date.now() + 1000; lightningState = 0; } launchEventEffect(eventType); }, 3000);
    }
    function launchEventEffect(eventType) {
        let duration = 6000 + (currentLevel * 1500); 
        if(eventType === 'TUNNEL') { isTunnelActive = true; tunnelEndTime = Date.now() + duration; } 
        else if(eventType === 'RADAR') { spawnRadar(); }
        else if(eventType === 'FOG') { isFogActive = true; fogEndTime = Date.now() + duration; }
        else if(eventType === 'ICE') { isIceActive = true; iceEndTime = Date.now() + duration; }
        else if(eventType === 'WORK') { isWorkActive = true; workEndTime = Date.now() + duration; startRoadWorks(); }
        else if(eventType === 'STORM') { isStormActive = true; stormEndTime = Date.now() + duration; }
        else if(eventType === 'TRUCK') { spawnTruck(); }
        else if(eventType === 'PHOTO') { isPhotoActive = true; photoZoneY = -600; spotterStopPointY = canvas.height - 250; }
        
        // BRINK'S
        else if(eventType === 'MONEY') { 
            brinksEndTime = Date.now() + 20000;
            spawnMoneyTruck(); 
        }
    }
    function spawnRadar() { radars.push({ x: ROAD_RIGHT + 5, y: -50, passed: false }); }
    function startRoadWorks() { let lane = Math.floor(Math.random() * 3); for(let i=0; i<6; i++) { cones.push({ x: getLaneX(lane) + CAR_W/2 - 15, y: -100 - (i*150), lane: lane }); } }
    function spawnTruck() { let laneIndex = Math.floor(Math.random() * 3); let obsX = getLaneX(laneIndex) - 7.5; obstacles.push({ x: obsX, y: -300, type: 'truck', w: 60, h: 240, img: truckImage, factor: 0.5, lane: laneIndex }); }
    
    // SPAWN BRINK'S TRUCK
    function spawnMoneyTruck() {
        let laneIndex = Math.floor(Math.random() * 3);
        let obsX = getLaneX(laneIndex) - 7.5;
        obstacles.push({ 
            x: obsX, 
            y: -300, 
            type: 'truck', 
            isMoneyTruck: true, 
            w: 60, 
            h: 240, 
            img: truckImage, 
            factor: 0.6, 
            lane: laneIndex,
            lastCoinDrop: 0 
        });
    }

    function showAlert(text, color, bg) { alertMsg.innerText = text; alertMsg.style.color = color; alertMsg.style.backgroundColor = bg; alertMsg.style.display = "block"; setTimeout(() => { alertMsg.style.display = "none"; }, 2500); }
    function triggerFlash() { flashOverlay.style.opacity = 1; setTimeout(() => { flashOverlay.style.opacity = 0; }, 150); }
    function getLaneX(laneIndex) { return ROAD_LEFT + (laneIndex * LANE_WIDTH) + (LANE_WIDTH - CAR_W) / 2; }
    function formatTime(ms) { let totalSeconds = Math.floor(ms / 1000); let minutes = Math.floor(totalSeconds / 60); let seconds = totalSeconds % 60; return (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds); }
    function updateHearts() { let h = ""; for(let i=0; i<lives; i++) h += "‚ù§Ô∏è"; for(let i=lives; i<(currentVipMode && currentVipMode.id === "RETRO" ? 10 : 3); i++) h += "üñ§"; heartsEl.innerText = h; }
    function drawLightning(x) { ctx.beginPath(); ctx.strokeStyle = "#aaddff"; ctx.lineWidth = 3; ctx.shadowBlur = 20; ctx.shadowColor = "white"; ctx.moveTo(x, 0); let currentY = 0; let currentX = x; while(currentY < canvas.height) { currentY += Math.random() * 30 + 10; currentX += (Math.random() - 0.5) * 40; ctx.lineTo(currentX, currentY); } ctx.stroke(); ctx.shadowBlur = 0; }

    function loop() {
        if(!gameRunning) return;
        if(isPaused) return; 

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let now = Date.now();

        if(isTunnelActive && now > tunnelEndTime) isTunnelActive = false;
        if(isFogActive && now > fogEndTime) isFogActive = false;
        if(isIceActive && now > iceEndTime) isIceActive = false;
        if(isWorkActive && now > workEndTime && cones.length === 0) isWorkActive = false;
        if(isStormActive && now > stormEndTime) isStormActive = false;
        if(isJumping && now > jumpEndTime) isJumping = false;
        if(isPosing) { drawGameStatic(); requestAnimationFrame(loop); return; }

        if (isBraking) {
            if (now > brakeEndTime) { isBraking = false; brakeCooldownEndTime = now + BRAKE_COOLDOWN_MS; brakeBtn.classList.remove('active'); brakeBtn.classList.add('cooldown'); }
        } else {
            if (now > brakeCooldownEndTime) { brakeBtn.classList.remove('cooldown'); } else { brakeBtn.classList.add('cooldown'); }
        }

        if (isNosActive) {
            if (now > nosEndTime) { isNosActive = false; targetSpeed = baseSpeed; nosContainer.style.display = 'flex'; }
        } else {
            if (isBraking) { targetSpeed = baseSpeed * 0.4; if (targetSpeed < 3) targetSpeed = 3; } 
            else { targetSpeed = baseSpeed + (Math.random() * 0.6); }
        }

        speed = lerp(speed, targetSpeed, 0.1); 
        
        if(currentVipMode && currentVipMode.id === "BOND") {
            nosBtn.innerText = bondAmmo;
            nosBarFill.style.width = (bondOvertakeCount / 100 * 100) + "%";
            if(bondAmmo > 0) { nosBtn.classList.add('ready'); nosBtn.style.border = "2px solid #00ff00"; nosBtn.style.color = "#00ff00"; } 
            else { nosBtn.classList.remove('ready'); nosBtn.style.borderColor = "red"; nosBtn.style.color = "red"; }
        }
        
        let scoreMult = (currentVipMode && currentVipMode.id === "GOLDEN") ? 2 : 1;
        distance += (speed / 1000) * scoreMult; 
        
        distEl.innerText = distance.toFixed(1);
        elapsedTime = now - startTime; timerEl.innerText = formatTime(elapsedTime);
        speedValEl.innerHTML = `${Math.floor(speed * 10)} km/h`; 

        let currentCarData = currentVipMode || carsData[currentCarIndex];
        
        if(!currentVipMode && !isNosActive) { 
            nosLevel = Math.min(100, nosLevel); 
            nosBarFill.style.width = nosLevel + "%";
            if (nosLevel >= 100) { nosBtn.classList.add('ready'); nosBtn.style.opacity = '1'; } else { nosBtn.classList.remove('ready'); nosBtn.style.opacity = '0.6'; }
        }
        if(currentVipMode && ["JUMP", "SPECTRE"].includes(currentVipMode.id)) { nosBarFill.style.width = nosLevel + "%"; }
        if(currentVipMode && currentVipMode.id === "POLICE") { nosLevel = 100; nosBarFill.style.width = "100%"; nosBtn.classList.add('ready'); nosBtn.style.opacity = '1'; }
        
        // DESSIN SCENE
        ctx.fillStyle = "#1a1a2e"; ctx.fillRect(0,0,canvas.width,canvas.height);
        if(bgImage.complete) { ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height); } 
        if(isIceActive) ctx.fillStyle = "#2c3e50"; else ctx.fillStyle = "#2c2c2c";
        ctx.fillRect(ROAD_LEFT, 0, ROAD_WIDTH, canvas.height);
        ctx.fillStyle = "#ffffff"; ctx.fillRect(ROAD_LEFT, 0, 4, canvas.height); ctx.fillRect(ROAD_RIGHT - 4, 0, 4, canvas.height);
        let line1X = ROAD_LEFT + LANE_WIDTH; let line2X = ROAD_LEFT + (LANE_WIDTH * 2);
        ctx.fillStyle = "rgba(255, 255, 255, 0.5)"; 
        roadLines = roadLines.filter((l) => {
            l.y += speed; ctx.fillRect(line1X - 2, l.y, 4, 30); ctx.fillRect(line2X - 2, l.y, 4, 30);
            return l.y <= canvas.height;
        });

        // GESTION ET DESSIN DES PI√àCES
        gameCoins = gameCoins.filter(c => {
            if(c.collected) return false;
            
            // Aimant
            if(magnetRange > 0) {
                let dx = (player.x + CAR_W/2) - c.x;
                let dy = (player.y + CAR_H/2) - c.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < magnetRange + 50) { c.x += dx * 0.15; c.y += dy * 0.15; }
            }

            c.y += speed;
            
            // Collision
            let pRight = player.x + CAR_W; let pBottom = player.y + CAR_H;
            if (player.x < c.x + 12 && pRight > c.x - 12 && player.y < c.y + 12 && pBottom > c.y - 12) {
                coinsCollected++; coinsValEl.innerText = coinsCollected; c.collected = true; return false; 
            }

            ctx.fillStyle = "#ffd700"; ctx.beginPath(); ctx.arc(c.x, c.y, 14, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = "#b8860b"; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = "#b8860b"; ctx.font = "bold 16px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("ü¶Å", c.x, c.y+1);

            return c.y <= canvas.height;
        });

        if(isPhotoActive) {
            photoZoneY += speed; 
            if (spottersImage.complete) {
                let spotterW = ROAD_LEFT * 0.8; let spotterH = spotterW * (spottersImage.height / spottersImage.width); let spotterX = ROAD_LEFT - spotterW - 10;
                ctx.drawImage(spottersImage, spotterX, photoZoneY, spotterW, spotterH);
            }
            ctx.fillStyle = "rgba(255, 0, 0, 0.3)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 150, ROAD_WIDTH, 300);
            ctx.fillStyle = "rgba(255, 165, 0, 0.4)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 90, ROAD_WIDTH, 180);
            ctx.fillStyle = "rgba(0, 255, 0, 0.6)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 40, ROAD_WIDTH, 80);
            ctx.fillStyle = "#fff"; ctx.fillRect(ROAD_LEFT, photoZoneY - 1, ROAD_WIDTH, 2);
            ctx.fillStyle = "#ffffff"; ctx.font = "bold 20px Courier New"; ctx.textAlign = "center"; ctx.fillText("ZONE PHOTO", ROAD_LEFT + ROAD_WIDTH/2, photoZoneY - 160);
            if(photoZoneY > canvas.height + 200 && !isPosing) isPhotoActive = false; 
        }

        let moveFactor = isIceActive ? 0.03 : 0.15 * handling;
        player.x += (player.targetX - player.x) * moveFactor;
        
        let opacity = (isInvincible && (Math.floor(now/100)%2===0)) ? 0.5 : 1;
        if(currentVipMode && currentVipMode.id === "SPECTRE" && isInvincible) opacity = 0.3;
        if(isInvincible && Date.now() > invincibilityTimer) isInvincible = false;

        for(let i=0; i<projectiles.length; i++) {
            let p = projectiles[i]; p.y -= 20;
            ctx.fillStyle = "yellow"; ctx.fillRect(p.x, p.y, p.w, p.h);
            if(p.y < 0) { projectiles.splice(i, 1); i--; }
        }

        if(isNosActive || (currentVipMode && currentVipMode.id === "POLICE")) {
            ctx.fillStyle = "rgba(0, 200, 255, 0.6)"; ctx.beginPath();
            ctx.moveTo(player.x + 10, player.y + CAR_H); ctx.lineTo(player.x + CAR_W/2, player.y + CAR_H + 40 + Math.random()*20); ctx.lineTo(player.x + CAR_W - 10, player.y + CAR_H); ctx.fill();
            player.x += (Math.random()-0.5)*2;
        }
        
        let drawW = CAR_W; let drawH = CAR_H;
        if(isJumping) {
            drawW *= 1.5; drawH *= 1.5; 
            ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(player.x + 10, player.y + 50, CAR_W, CAR_H/2);
        }
        if(currentVipMode && currentVipMode.id === "MICRO") { drawW *= 0.6; drawH *= 0.6; }
        
        let displayImg = currentVipMode ? currentVipMode.imgObj : loadedImages[currentCarIndex];

        drawRotated(ctx, displayImg, player.x - (drawW-CAR_W)/2, player.y - (drawH-CAR_H)/2, drawW, drawH, ROTATION_ANGLE - ((player.x - player.targetX) * 0.5), opacity);

        radars = radars.filter((r) => {
            r.y += speed; ctx.fillStyle = "#888"; ctx.fillRect(r.x, r.y, 5, 50); ctx.fillStyle = "#444"; ctx.fillRect(r.x-10, r.y, 15, 20); ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.fillRect(ROAD_LEFT, r.y + 100, ROAD_WIDTH, 5);
            if (!r.passed && r.y + 100 > player.y + 20) { 
                r.passed = true;
                if (speed * 10 > RADAR_SPEED_LIMIT) { triggerFlash(); lives--; updateHearts(); if(lives <= 0) { gameOver('FLASH'); } else { showAlert(`FLASH√â !`, "red", "white"); } }
            }
            return r.y <= canvas.height;
        });

        cones = cones.filter((c, i) => {
            c.y += speed; ctx.fillStyle = "orange"; ctx.beginPath(); ctx.moveTo(c.x + 15, c.y); ctx.lineTo(c.x, c.y + 30); ctx.lineTo(c.x + 30, c.y + 30); ctx.fill();
            for(let k=0; k<projectiles.length; k++) {
                let p = projectiles[k];
                if(p.x > c.x + 30 && p.x + p.w > c.x && p.y < c.y + 30 && p.y + p.h > c.y) {
                    cones.splice(i, 1); projectiles.splice(k, 1); return false;
                }
            }
            if(!isInvincible && !isNosActive && !isJumping && player.x < c.x + 30 && player.x + CAR_W > c.x && player.y < c.y + 30 && player.y + CAR_H > c.y) {
                lives--; updateHearts(); if(lives <= 0) { gameOver('CRASH'); } else { isInvincible = true; invincibilityTimer = Date.now() + 2000; showAlert("TRAVAUX !", "orange", "black"); }
            }
            return c.y <= canvas.height;
        });

        bonuses = bonuses.filter((b, i) => {
            b.y += speed; ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("üîß", b.x + b.w/2, b.y + b.h/2);
            if (player.x < b.x + b.w && player.x + CAR_W > b.x && player.y < b.y + b.h && player.y + CAR_H > b.y) {
                if(lives < (hasExtraLives ? 10 : 3)) { lives++; updateHearts(); } return false;
            }
            return b.y <= canvas.height;
        });

        for (let i = 0; i < obstacles.length; i++) {
            let obs = obstacles[i];
            
            // --- 1. LOGIQUE SP√âCIALE BRINK'S ---
            if (obs.isMoneyTruck) {
                let timeRemaining = brinksEndTime - Date.now();

                // TANT QU'IL RESTE DU TEMPS
                if (timeRemaining > 0) {
                    // Gestion des pi√®ces
                    if (obs.y > 0 && obs.y < canvas.height) {
                        if (!obs.lastCoinDrop || obs.y - obs.lastCoinDrop > 100) {
                            gameCoins.push({ x: obs.x + 30 + (Math.random()*20 - 10), y: obs.y + 240, w: 25, h: 25, collected: false });
                            obs.lastCoinDrop = obs.y;
                        }
                    }
                    
                    // Mouvement : Reste devant le joueur
                    if (obs.y < 150) {
                        obs.y += 3; 
                    } else {
                        obs.y -= 0.2; 
                    }
                } 
                // LE TEMPS EST √âCOUL√â : IL PART
                else {
                    obs.y -= 15; // Il acc√©l√®re vers le haut
                    
                    // --- CORRECTION DU BUG ICI ---
                    if (obs.y < -400) {
                        obstacles.splice(i, 1);
                        i--;
                        continue; 
                    }
                }
            } 
            // --- 2. MOUVEMENT STANDARD ---
            else {
                let mySpeed = speed;
                if (obs.type === 'truck') { 
                    obs.x += 0; 
                    let enemyBaseSpeed = speed * obs.factor; 
                    obs.y += (mySpeed - enemyBaseSpeed); 
                } 
                else {
                    let braking = false;
                    for(let j = 0; j < obstacles.length; j++) { 
                        if (i !== j && obstacles[j].type !== 'truck') { 
                            let other = obstacles[j]; 
                            if (other.y > obs.y && other.y < obs.y + 200 && Math.abs(other.x - obs.x) < 20) { braking = true; } 
                        } 
                    }
                    let enemyBaseSpeed = speed * obs.factor; 
                    if (braking) enemyBaseSpeed = speed; 
                    obs.y += (mySpeed - enemyBaseSpeed);
                }
            }
            
            // Gestion collision projectiles
            let hitByProjectile = false;
            for(let k=0; k<projectiles.length; k++) {
                let p = projectiles[k];
                if(p.x > obs.x && p.x < obs.x + CAR_W && p.y < obs.y + CAR_H && p.y > obs.y) {
                    obstacles.splice(i, 1); projectiles.splice(k, 1); i--; hitByProjectile = true; break;
                }
            }
            if(hitByProjectile) continue; 

            let obsOp = isNosActive ? 0.5 : 1;
            if(currentVipMode && currentVipMode.id === "SPECTRE" && isInvincible) obsOp = 0.3;

            // --- 3. DESSIN ---
            if(isTunnelActive && !isNosActive && !(currentVipMode && currentVipMode.id === "POLICE")) { } else {
                if(isFogActive) { let visibility = Math.max(0, (obs.y) / (canvas.height/2)); ctx.globalAlpha = Math.min(1, visibility); }
                
                if(obs.type === 'truck') {
                       ctx.save(); ctx.translate(obs.x + 30, obs.y + 120); 
                       
                       if (obs.isMoneyTruck) {
                           // === CAMION BRINKS (Blanc/Gris, Invers√©) ===
                           ctx.rotate(Math.PI / 2); // Rotation 90¬∞
                           
                           // Filtre pour le rendre gris/blanc
                           ctx.filter = "grayscale(100%) brightness(1.5)";
                           
                           if (truckImage.complete) { 
                               ctx.drawImage(truckImage, -120, -30, 240, 60); 
                           } else { 
                               ctx.fillStyle = "#ccc"; ctx.fillRect(-120, -30, 240, 60); 
                           }
                           
                           ctx.filter = "none"; // Reset filtre pour le texte

                           // Texte
                           ctx.fillStyle = "#000000";
                           ctx.font = "900 28px Arial Black, Arial, sans-serif";
                           ctx.textAlign = "center"; ctx.textBaseline = "middle";
                           ctx.fillText("BRINK'S", 0, 0);

                       } else {
                           // === CAMION NORMAL ===
                           ctx.rotate(-Math.PI / 2);
                           if (truckImage.complete) { ctx.drawImage(truckImage, -120, -30, 240, 60); } else { ctx.fillStyle = "blue"; ctx.fillRect(-120, -30, 240, 60); }
                       }
                       ctx.restore();
                } else { 
                    drawRotated(ctx, obs.img, obs.x, obs.y, CAR_W, CAR_H, ROTATION_ANGLE, obsOp); 
                }
                ctx.globalAlpha = 1;
            }
            
            // --- 4. COLLISIONS JOUEUR ---
            let hit = false;
            let obsW = CAR_W; let obsH = CAR_H;
            if (obs.type === 'truck') { obsW = 60; obsH = 240; }
            let pW = (currentVipMode && currentVipMode.id === "MICRO") ? CAR_W * 0.6 : CAR_W;
            let pH = (currentVipMode && currentVipMode.id === "MICRO") ? CAR_H * 0.6 : CAR_H;

            if (!isInvincible && !isNosActive && !isJumping) {
                 if (player.x < obs.x + obsW - 5 && player.x + pW - 5 > obs.x && player.y < obs.y + obsH - 5 && player.y + pH - 5 > obs.y) { 
                       hit = true; 
                       let safeZoneY = obs.y + (obsH * 0.80); 
                       if (player.y + pH < safeZoneY) { hit = false; }
                 }
            }
            
            if (hit) { 
                if (currentVipMode && currentVipMode.id === "BULLDOZER" && obs.type !== 'truck') {
                      obstacles.splice(i, 1); i--; photoBonusScore += 50 * scoreMult; photoScoreEl.innerText = photoBonusScore;
                } else {
                    lives--; updateHearts(); 
                    if(lives <= 0) { gameOver('CRASH'); } 
                    else { 
                        isInvincible = true; 
                        let bonusShield = 0;
                        if(currentGameMode === 'CAREER' && savedData.garage[currentCarIndex]) {
                           bonusShield = savedData.garage[currentCarIndex].upgrades.shield * 500;
                        }
                        invincibilityTimer = Date.now() + 2000 + bonusShield; 
                        obs.y += 100; 
                    } 
                }
            }
            
            // --- 5. NETTOYAGE (Sortie par le bas) ---
            if(obs.y > canvas.height) {
                if (obs.type !== 'truck' && (!currentVipMode || currentVipMode.id !== "POLICE")) { nosLevel = Math.min(100, nosLevel + 1); }
                if (currentVipMode && currentVipMode.id === "BOND" && obs.type !== 'truck') {
                     if (bondAmmo < 15) {
                         bondOvertakeCount++;
                         if (bondOvertakeCount >= 100) { bondAmmo = 15; bondOvertakeCount = 0; showAlert("MISSILES RECHARG√âS !", "#00ff00", "black"); }
                     }
                }
                obstacles.splice(i, 1); i--;
            }
        }

        if (isTunnelActive) {
            ctx.fillStyle = "rgba(0,0,0,0.98)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.globalCompositeOperation = "destination-out";
            ctx.beginPath(); ctx.moveTo(player.x + 10, player.y + 10); ctx.lineTo(player.x - 20, player.y - 400); ctx.lineTo(player.x + 20, player.y - 400); ctx.fill();
            ctx.beginPath(); ctx.moveTo(player.x + CAR_W - 10, player.y + 10); ctx.lineTo(player.x + CAR_W - 20, player.y - 400); ctx.lineTo(player.x + CAR_W + 20, player.y - 400); ctx.fill();
            ctx.restore();
            obstacles.forEach(obs => {
                 if (obs.type === 'truck') { ctx.fillStyle = "#ff0000"; ctx.shadowColor = "red"; ctx.shadowBlur = 20; ctx.fillRect(obs.x + 10, obs.y + 240 - 5, 10, 5); ctx.fillRect(obs.x + 60 - 20, obs.y + 240 - 5, 10, 5); } 
                 else { ctx.fillStyle = "#ff0000"; ctx.shadowColor = "red"; ctx.shadowBlur = 20; ctx.fillRect(obs.x + 5, obs.y + CAR_H - 5, 8, 5); ctx.fillRect(obs.x + (CAR_W) - 13, obs.y + CAR_H - 5, 8, 5); }
                 ctx.shadowBlur = 0;
            });
        }

        if(isFogActive) { let grad = ctx.createLinearGradient(0, 0, 0, canvas.height/2); grad.addColorStop(0, "rgba(200, 200, 200, 0.95)"); grad.addColorStop(1, "rgba(200, 200, 200, 0)"); ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height); }

        if(isStormActive) {
            let now = Date.now();
            if (lightningState === 0 && now > lightningNextStrike) { lightningLane = Math.floor(Math.random() * 3); lightningState = 1; lightningTimer = now + 1000; }
            if (lightningState === 1) {
                let laneX = getLaneX(lightningLane) + CAR_W/2; let laneY = canvas.height / 2;
                if (Math.floor(now / 100) % 2 === 0) { ctx.font = "80px Arial"; ctx.fillStyle = "red"; ctx.textAlign = "center"; ctx.fillText("‚ö†Ô∏è", laneX, laneY); ctx.fillStyle = "rgba(255, 0, 0, 0.3)"; ctx.fillRect(getLaneX(lightningLane), 0, LANE_WIDTH, canvas.height); }
                if (now > lightningTimer) { lightningState = 2; lightningTimer = now + 300; triggerFlash(); }
            }
            if (lightningState === 2) {
                let laneX = getLaneX(lightningLane) + CAR_W/2; drawLightning(laneX);
                if (!isInvincible && !isNosActive && !isJumping && player.laneIndex === lightningLane) { lives--; updateHearts(); if(lives <= 0) { gameOver('CRASH'); } else { isInvincible = true; invincibilityTimer = Date.now() + 2000; showAlert("FOUDROY√â !", "yellow", "black"); } }
                if (now > lightningTimer) { lightningState = 0; lightningNextStrike = now + 2000 + Math.random() * 2000; }
            }
            ctx.strokeStyle = "rgba(255,255,255,0.5)"; ctx.lineWidth = 1; ctx.beginPath();
            for(let i=0; i<10; i++) { let rx = Math.random() * canvas.width; let ry = Math.random() * canvas.height; ctx.moveTo(rx, ry); ctx.lineTo(rx - 5, ry + 20); } ctx.stroke();
        }

        requestAnimationFrame(loop);
    }

    function drawGameStatic() {
        if(bgImage.complete) { ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height); } 
        ctx.fillStyle = "#2c2c2c"; ctx.fillRect(ROAD_LEFT, 0, ROAD_WIDTH, canvas.height);
        ctx.fillStyle = "#ffffff"; ctx.fillRect(ROAD_LEFT, 0, 4, canvas.height); ctx.fillRect(ROAD_RIGHT - 4, 0, 4, canvas.height);
        let line1X = ROAD_LEFT + LANE_WIDTH; let line2X = ROAD_LEFT + (LANE_WIDTH * 2);
        ctx.fillStyle = "rgba(255, 255, 255, 0.5)"; 
        roadLines.forEach((l) => { ctx.fillRect(line1X - 2, l.y, 4, 30); ctx.fillRect(line2X - 2, l.y, 4, 30); });
        
        if(isPhotoActive) {
            if(spottersImage.complete) {
                 let spotterW = ROAD_LEFT * 0.8; let spotterH = spotterW * (spottersImage.height / spottersImage.width); let spotterX = ROAD_LEFT - spotterW - 10;
                 ctx.drawImage(spottersImage, spotterX, photoZoneY, spotterW, spotterH);
            }
            ctx.fillStyle = "rgba(255, 0, 0, 0.3)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 150, ROAD_WIDTH, 300);
            ctx.fillStyle = "rgba(255, 165, 0, 0.4)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 90, ROAD_WIDTH, 180);
            ctx.fillStyle = "rgba(0, 255, 0, 0.6)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 40, ROAD_WIDTH, 80);
            ctx.fillStyle = "#fff"; ctx.fillRect(ROAD_LEFT, photoZoneY - 1, ROAD_WIDTH, 2);
        }
        
        let drawW = CAR_W; let drawH = CAR_H;
        if(currentVipMode && currentVipMode.id === "MICRO") { drawW *= 0.6; drawH *= 0.6; }
        
        let displayImg = currentVipMode ? currentVipMode.imgObj : loadedImages[currentCarIndex];

        drawRotated(ctx, displayImg, player.x - (drawW-CAR_W)/2, player.y - (drawH-CAR_H)/2, drawW, drawH, ROTATION_ANGLE, 1);
        
        obstacles.forEach((obs) => {
            if(obs.type === 'truck') {
                 ctx.save(); ctx.translate(obs.x + 30, obs.y + 120); ctx.rotate(-Math.PI / 2); 
                 if (truckImage.complete) { ctx.drawImage(truckImage, -120, -30, 240, 60); } else { ctx.fillStyle = "blue"; ctx.fillRect(-120, -30, 240, 60); }
                 ctx.restore();
            } else { drawRotated(ctx, obs.img, obs.x, obs.y, CAR_W, CAR_H, 0); }
        });
    }

    // --- NOUVELLES FONCTIONS DE NAVIGATION (FIN DE PARTIE) ---
    window.restartGame = function() {
        gameOverScreen.style.display = 'none';
        gameRunning = false; 
        startGame(); 
    };

    window.backToGarage = function() {
        gameOverScreen.style.display = 'none';
        menuScreen.style.display = 'flex';
        document.getElementById('brake-btn').style.display = 'none';
        document.getElementById('nos-container').style.display = 'none';
        document.getElementById('pause-btn').style.display = 'none';
        updateMenu(); 
    };

    window.backToTitle = function() {
        gameOverScreen.style.display = 'none';
        menuScreen.style.display = 'none';
        careerScreen.style.display = 'none';
        leaderboardScreen.style.display = 'none';
        document.getElementById('brake-btn').style.display = 'none';
        document.getElementById('nos-container').style.display = 'none';
        document.getElementById('pause-btn').style.display = 'none';
        document.getElementById('titleScreen').style.display = 'flex';
    };

    // CHARGER LA SAUVEGARDE AU D√âMARRAGE
    menuScreen.style.display = 'none';
    document.getElementById('titleScreen').style.display = 'flex';
    loadSaveData();
</script>
</body>
</html>
