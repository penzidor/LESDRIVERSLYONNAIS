<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Les Drivers Lyonnais - Version LootLocker</title>
<style>
    body {
        margin: 0; padding: 0; 
        background-color: #1a1a2e;
        overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif;
        user-select: none; -webkit-user-select: none;
    }
    canvas {
        display: block; margin: 0 auto;
        position: absolute; top: 0; left: 0; z-index: 10;
        image-rendering: pixelated; 
    }
    
    /* HUD GAUCHE */
    #ui {
        position: absolute; top: 10px; left: 15px; color: #fff;
        font-family: 'Courier New', monospace; pointer-events: none; z-index: 30;
    }
    .hud-line {
        font-size: 20px; font-weight: bold; text-shadow: 2px 2px 0px #000;
        margin-bottom: 5px;
    }
    #hearts { color: #ff3333; font-size: 24px; }

    /* HUD DROIT (Vitesse) - STYLE N√âON */
    #speedometer {
        position: absolute; top: 10px; 
        right: 10px; 
        color: #fff;
        font-family: 'Courier New', monospace; pointer-events: none; z-index: 30;
        font-size: 11px; 
        font-weight: bold; text-shadow: 1px 1px 0px #000;
        padding: 3px 6px; 
        line-height: 1.1;

        border: 2px solid #00ffff; 
        border-radius: 8px;
        background-color: rgba(0,0,0,0.4);
        box-shadow: 
            0 0 5px rgba(0, 255, 255, 0.7),
            inset 0 0 5px rgba(0, 255, 255, 0.3);
    }
    #speedVal {
        color: #00ffff;
        text-shadow: 0 0 4px #00ffff;
        font-weight: 800;
        display: inline-block;
        font-size: 16px; 
    }
    #speedometer .hud-label {
        font-size: 11px;
        color: #aaa;
        display: inline;
    }

    /* BOUTON PAUSE */
    #pause-btn {
        position: absolute; top: 60px; right: 10px;
        font-size: 30px; cursor: pointer; z-index: 40;
        filter: drop-shadow(0 0 2px black);
        transition: transform 0.1s;
        display: none; 
    }
    #pause-btn:active { transform: scale(0.9); }

    /* ALERTES & NOTES */
    #alert-msg {
        position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%);
        font-family: 'Arial Black', sans-serif; font-size: 24px; 
        text-align: center; display: none; z-index: 60; pointer-events: none;
        padding: 15px 30px; border-radius: 10px; border: 4px solid white;
        background: rgba(0,0,0,0.85); text-shadow: 0 0 10px black;
        width: 80%; box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }

    #photo-grade {
        position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg);
        font-family: 'Arial Black', sans-serif; font-size: 60px; 
        color: #ff00ff; text-shadow: 5px 5px 0px #00ffff;
        display: none; z-index: 80; pointer-events: none;
        animation: pop 0.5s ease-out;
    }
    @keyframes pop { 0% {transform: translate(-50%, -50%) scale(0);} 80% {transform: translate(-50%, -50%) scale(1.2);} 100% {transform: translate(-50%, -50%) scale(1);} }

    /* FLASH ECRAN */
    #flash-overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: white; opacity: 0; pointer-events: none; z-index: 70;
        transition: opacity 0.1s;
    }
    .spotter-flash {
        position: absolute; background: white; border-radius: 50%;
        opacity: 0; pointer-events: none; z-index: 71;
        box-shadow: 0 0 20px 10px white;
    }

    /* --- CONTR√îLES --- */

    #brake-btn {
        position: absolute; bottom: 10px; left: 20px;
        width: 70px; height: 100px;
        background-image: url('https://i.ibb.co/vCXmMHbH/058451a1-cbfc-4624-b9b1-1dc40c1db1ce.jpg');
        background-size: contain; background-repeat: no-repeat; background-position: center;

        border: 3px solid #00ffff; border-radius: 12px; 
        box-shadow: 0 0 5px rgba(0, 255, 255, 0.7), 0 0 10px rgba(0, 255, 255, 0.5), inset 0 0 5px rgba(0, 255, 255, 0.3); 
        background-color: rgba(0,0,0,0.3); 
        
        color: white; font-weight: 900; font-size: 16px;
        text-shadow: 2px 2px 4px #000, 0 0 5px #00ffff; 
        cursor: pointer; display: none; 
        
        align-items: flex-end; justify-content: center;
        padding-bottom: 15px; box-sizing: border-box;
        
        z-index: 50; transition: transform 0.1s, filter 0.2s, box-shadow 0.2s, border-color 0.2s;
    }
    #brake-btn.active { 
        transform: scale(0.90) translateY(5px);
        filter: sepia(1) saturate(5) hue-rotate(-50deg) brightness(1.5);
        border-color: #ff0000;
        box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff3300, inset 0 0 10px #ff0000;
        text-shadow: 2px 2px 4px #000, 0 0 10px #ff0000;
    }
    #brake-btn.cooldown {
        cursor: not-allowed; transform: scale(1);
        border-color: #444; box-shadow: none;
        filter: grayscale(100%) brightness(0.5); opacity: 0.7; text-shadow: none;
    }

    #nos-container {
        position: absolute; bottom: 10px; right: 10px;
        display: none; flex-direction: column; align-items: center; z-index: 50;
    }
    #nos-bar-bg {
        width: 90px; height: 10px; background: #333; border: 2px solid #fff;
        border-radius: 10px; overflow: hidden; margin-bottom: 5px;
    }
    #nos-bar-fill {
        width: 0%; height: 100%; background: linear-gradient(90deg, #00ffff, #0000ff);
        transition: width 0.2s ease-out;
    }
    #nos-btn {
        width: 90px; height: 90px; border-radius: 50%;
        background: radial-gradient(circle, #333, #111);
        border: 2px solid #00ffff; color: #00ffff;
        text-shadow: 0 0 5px #00ffff;
        box-shadow: 0 0 5px rgba(0, 255, 255, 0.3), inset 0 0 5px rgba(0, 255, 255, 0.2);
        font-weight: bold; font-size: 24px; cursor: default;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.3s; opacity: 0.6;
        text-align: center; line-height: 1; 
        pointer-events: auto;
        user-select: none;
    }
    #nos-btn.ready {
        background: radial-gradient(circle, #ff0000, #990000);
        border-color: #ffaaaa; color: white; cursor: pointer;
        opacity: 1; box-shadow: 0 0 25px #ff0000; text-shadow: 0 0 10px white;
        animation: pulse 1s infinite;
    }
    @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }
    
    .screen-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(20, 10, 40, 0.98); 
        display: flex; flex-direction: column;
        justify-content: flex-start; align-items: center;
        color: white; z-index: 100; pointer-events: auto;
        overflow-y: auto; touch-action: pan-y; -webkit-overflow-scrolling: touch;
        padding-top: 50px; padding-bottom: 50px; box-sizing: border-box;
    }
    #leaderboardScreen, #gameOverScreen, #instructionsScreen, #vipLoginScreen, #vipMenuScreen, #pauseScreen { display: none; z-index: 110; }
    
    h1 { color: #ff00ff; text-shadow: 3px 3px #00ffff; margin-bottom: 5px; text-align: center; font-style: italic; font-size: 32px; font-family: 'Courier New', monospace;}
    
    /* VIP MENU GRID */
    #vipGrid {
        display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 95%; max-width: 600px;
    }
    .vip-card {
        width: 140px; background: rgba(0,0,0,0.6); border: 2px solid #555; border-radius: 8px;
        padding: 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer;
        transition: transform 0.1s, border-color 0.2s;
    }
    .vip-card:active { transform: scale(0.95); }
    .vip-card h4 { margin: 5px 0; color: #fff; font-size: 14px; text-align: center; }
    .vip-card span { font-size: 10px; color: #aaa; text-align: center; }
    .vip-card.selected { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; }

    /* GAME OVER STYLING */
    #gameOverTitle { color: #ff0000; font-size: 36px; text-shadow: 0 0 10px #ff0000, 0 0 20px #800000; margin-bottom: 20px; }
    .final-score-line { font-family: 'Courier New', monospace; font-size: 22px; margin-bottom: 10px; }
    .final-score-value { color: #00ffff; text-shadow: 0 0 5px #00ffff; font-weight: bold; }
    
    #highScoreZone { background: rgba(0, 255, 0, 0.1); border: 2px solid #00ff00; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; display: none; flex-direction: column; align-items: center; }
    #nameInput, #vipPasswordInput { padding: 10px; margin-top: 10px; margin-bottom: 10px; font-size: 18px; background: #111; border: 2px solid #00ff00; color: #00ffff; text-align: center; width: 200px; }
    #submitBtn, #loginBtn { background: #00aa00; border: 1px solid #00ff00; color: white; padding: 8px 20px; font-size: 16px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; margin-top: 10px; }
    
    #vipPasswordInput { border-color: #ff00ff; color: #ff00ff; }
    #loginBtn { background: #550055; border-color: #ff00ff; }
    
    p { color: #ccc; margin-bottom: 25px; font-size: 14px; letter-spacing: 1px;}
    #garage { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; pointer-events: auto; }
    .car-box { width: 140px; height: 180px; border: 4px solid #00ffff; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; flex-shrink: 0; }
    #previewCanvas { width: 100%; height: 100%; }
    .nav-btn { background: #3a1a5a; border: 2px solid #ff00ff; color: #00ffff; font-size: 24px; width: 50px; height: 50px; cursor: pointer; margin: 0 15px; display: flex; align-items: center; justify-content: center; transition: 0.1s; z-index: 101; pointer-events: auto; }
    #carName { color: #00ffff; margin-top: 5px; font-size: 22px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 0px #ff00ff; font-family: 'Courier New', monospace; }
    #carStats { font-family: 'Courier New', monospace; font-size: 16px; color: #fff; margin-bottom: 20px; text-align: center; line-height: 1.6; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; border: 1px solid #555; }
    .stat-bar { color: #ffff00; text-shadow: 0 0 5px #ff0000; }
    
    button.action-btn { margin-top: 10px; padding: 15px 40px; font-size: 20px; background: #ff00ff; border: 3px solid #00ffff; color: white; box-shadow: 4px 4px 0px rgba(0,0,0,0.8); font-weight: bold; cursor: pointer; text-transform: uppercase; font-family: 'Courier New', monospace; z-index: 101; pointer-events: auto; display: block; margin-bottom: 10px; }
    button.secondary-btn { background: #3a1a5a; border-color: #aaa; color: #ccc; font-size: 16px; padding: 10px 20px; }

    .leaderboard-content { display: flex; align-items: center; justify-content: center; gap: 15px; width: 90%; max-width: 500px; flex-wrap: wrap; }
    #scoreTable { flex: 1; border-collapse: collapse; font-family: 'Courier New', monospace; background: rgba(0,0,0,0.5); border-radius: 10px; padding: 10px; min-width: 250px; }
    #scoreTable th { border-bottom: 2px solid #00ffff; padding: 8px; color: #ff00ff; font-size: 14px;}
    #scoreTable td { padding: 6px; text-align: center; border-bottom: 1px solid #555; font-size: 14px;}
    #scoreTable tr:first-child td { color: yellow; font-weight: bold; }
    #pilotMascot { width: 100px; height: auto; filter: drop-shadow(0 0 10px #00ffff); }

    .instruction-section { max-width: 500px; width: 90%; margin: 10px auto; padding: 15px; border: 1px solid #00ffff; background: rgba(0, 0, 0, 0.5); border-radius: 5px; text-align: left; }
    .instruction-section h3 { color: #ff00ff; text-shadow: 0 0 5px #ff00ff; margin-top: 0; margin-bottom: 5px; font-size: 18px; }
</style>
</head>
<body>

<div id="flash-overlay"></div>
<div id="alert-msg">ATTENTION</div>
<div id="photo-grade">S</div>

<div id="ui">
    <div class="hud-line">DIST: <span id="distVal">0.0</span> km</div>
    <div class="hud-line">VIES: <span id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    <div class="hud-line" style="font-size:16px; color:#aaa;" id="timer">00:00</div>
    <div class="hud-line" style="font-size:16px; color:#ffff00;">BONUS PHOTO: <span id="photoScore">0</span></div>
</div>

<div id="speedometer">
    <span class="hud-label">VITESSE:</span> <span id="speedVal">0 km/h</span>
</div>

<div id="pause-btn" onclick="togglePause()">‚è∏Ô∏è</div>

<div id="brake-btn" ontouchstart="triggerBrake(event)" onmousedown="triggerBrake(event)">FREIN</div>

<div id="nos-container">
    <div id="nos-bar-bg"><div id="nos-bar-fill"></div></div>
    <div id="nos-btn" ontouchstart="activateNOS(event)" onmousedown="activateNOS(event)">NOS</div>
</div>

<div id="pauseScreen" class="screen-overlay">
    <h1>PAUSE</h1>
    <p>Le jeu est en pause.</p>
    <button class="action-btn" onclick="togglePause()">REPRENDRE</button>
    <button class="action-btn secondary-btn" onclick="window.location.reload()">QUITTER (MENU)</button>
</div>

<div id="menuScreen" class="screen-overlay">
    <h1>LES DRIVERS<br>LYONNAIS</h1>
    <p>S√©lectionne ton bolide</p>
    <div id="garage">
        <button class="nav-btn" onclick="changeCar(-1)">&#10094;</button>
        <div class="car-box"><canvas id="previewCanvas"></canvas></div>
        <button class="nav-btn" onclick="changeCar(1)">&#10095;</button>
    </div>
    <div id="carName">NOM</div>
    <div id="carStats">
        <span style="color:#aaa;font-weight:bold;">RAPIDIT√â :</span> <span id="statSpeed" class="stat-bar"></span><br>
        <span style="color:#aaa;font-weight:bold;">MANIABILIT√â :</span> <span id="statHand" class="stat-bar"></span>
    </div>
    <button class="action-btn" onclick="startGame()">D√âMARRER</button>
    <button class="action-btn secondary-btn" onclick="showLeaderboard()">üèÜ SCORES (LOOTLOCKER)</button>
    <button class="action-btn secondary-btn" onclick="showInstructions()">‚ÑπÔ∏è INSTRUCTIONS</button>
    <button class="action-btn secondary-btn" style="border-color:#ff00ff; color:#ff00ff;" onclick="showVipLogin()">üîê CONNEXION VIP</button>
</div>

<div id="vipLoginScreen" class="screen-overlay">
    <h1>ACC√àS VIP (Mot de Passe)</h1>
    <p>Entrez le mot de passe secret re√ßu lors de l'inscription sur le canal LESDRIVERS.</p>
    <input type="password" id="vipPasswordInput" placeholder="Mot de passe" style="width:250px;">
    
    <button id="loginBtn" onclick="loginVipUser()">SE CONNECTER</button>
    
    <p id="vipError" style="color:red; display:none; margin-top:10px;">Mot de passe incorrect.</p>
    <p id="vipSuccess" style="color:#00ff00; display:none; margin-top:10px;"></p>

    <button class="action-btn secondary-btn" onclick="closeVipLogin()">RETOUR</button>
</div>

<div id="vipMenuScreen" class="screen-overlay">
    <h1 style="color:#ffff00; text-shadow:0 0 10px orange;">GARAGE VIP</h1>
    <p>CHOISIS TON MODE DE JEU</p>
    <div id="vipGrid">
        </div>
    <button class="action-btn secondary-btn" onclick="closeVipMenu()">RETOUR</button>
</div>

<div id="instructionsScreen" class="screen-overlay">
    <h1>INSTRUCTIONS</h1>
    <div class="instruction-section">
        <h3>BUT DU JEU</h3>
        <p>Atteignez la plus grande distance possible tout en g√©rant le trafic et les √©v√©nements sp√©ciaux.</p>
    </div>
    <div class="instruction-section">
        <h3>CONTROLES (TACTILE)</h3>
        <p>‚Ä¢ **TAP GAUCHE/DROIT** : Se d√©placer.</p>
        <p>‚Ä¢ **BOUTON FREIN** : Ralentir (Slow Motion).</p>
        <p>‚Ä¢ **BOUTON NOS** : Action sp√©ciale.</p>
    </div>
    <div class="instruction-section">
        <h3>CONTROLES (PC)</h3>
        <p>‚Ä¢ **FL√àCHES** : Se d√©placer.</p>
        <p>‚Ä¢ **A** : Freiner.</p>
        <p>‚Ä¢ **Z** : NOS / Action Sp√©ciale.</p>
    </div>
    <button class="action-btn" onclick="closeInstructions()">RETOUR AU MENU</button>
</div>

<div id="leaderboardScreen" class="screen-overlay">
    <h1>TOP PILOTES</h1>
    <div class="leaderboard-content">
        <table id="scoreTable">
            <thead><tr><th>#</th><th>NOM</th><th>DIST</th></tr></thead>
            <tbody id="scoreList"></tbody>
        </table>
        <img id="pilotMascot" src="https://i.ibb.co/cSHRYhPV/file-00000000b0dc71f4962ea895363a14af-2.png" alt="Pilote">
    </div>
    <button class="action-btn" onclick="closeLeaderboard()">RETOUR</button>
</div>

<div id="gameOverScreen" class="screen-overlay">
    <h1 id="gameOverTitle">T'A BROYER L'AUTO !</h1>
    <div class="final-score-line">DIST. PARCOURUE : <span id="goDistance" class="final-score-value">0.0 km</span></div>
    <div class="final-score-line">BONUS PHOTO : <span id="goBonus" class="final-score-value">0</span></div>
    <div class="final-score-line" style="margin-top: 15px;">SCORE TOTAL : <span id="goFinalScore" class="final-score-value">0.00</span></div>
    
    <div id="highScoreZone">
        <p style="color:#00ff00; font-weight:bold; margin-bottom:5px;">üéâ NOUVEAU RECORD (TOP 10) !</p>
        <input type="text" id="nameInput" placeholder="ENTRER NOM (MAX 10 L.)" maxlength="10">
        <button id="submitBtn" onclick="submitScore()">VALIDER LE SCORE</button>
    </div>

    <button class="action-btn" onclick="window.location.reload()">RECOMMENCER</button>
    <button class="action-btn secondary-btn" onclick="window.location.reload()">RETOUR MENU</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const ROTATION_ANGLE = 0; 
    const CAR_W = 45; 
    const CAR_H = 95;
    const BG_URL = "https://i.ibb.co/B2zdFmwb/1765327821263.jpg";
    
    // IMAGE POUR LE CAMION (CONVOI)
    const TRUCK_URL = "https://i.ibb.co/hFm7Q136/1765393224904.png";
    const SPOTTERS_URL = "https://i.ibb.co/tTLS0PyH/Gemini-Generated-Image-t1crwt1crwt1crwt-1.png";

    const TRUCK_W_FIXED = 240; 
    const TRUCK_H_FIXED = 60;  
    const RADAR_SPEED_LIMIT = 70; 
    
    const BRAKE_DURATION_MS = 3000; 
    const BRAKE_COOLDOWN_MS = 2000; 

    // --- CONFIGURATION LOOTLOCKER (CLASSEMENT) ---
    const LL_GAME_ID = "101303"; 
    const LL_API_KEY = "dev_6e2e629f217946e39970b94134c58686";
    const LL_LEADERBOARD_ID = "32340"; 
    
    let llSessionToken = "";

    // --- CONFIGURATION VIP (SIMPLIFI√âE) ---
    const VIP_PASSWORD = "LYON"; 

    const ENEMY_SPRITE_URLS = [
        "https://i.ibb.co/gbGhCsq3/1765396878722.png",
        "https://i.ibb.co/0yhcjXy5/1765397118940.png",
        "https://i.ibb.co/QvdHHpdk/1765397118940-1.png",
        "https://i.ibb.co/XkMHYVc5/1765397118940-2.png",
        "https://i.ibb.co/whXpcKD7/1765397118940-3.png",
        "https://i.ibb.co/W4DPrBR5/1765397118940-4.png",
        "https://i.ibb.co/PG2LqnSX/1765397132500-4.png",
        "https://i.ibb.co/G41PXzjB/1765397132500-5.png",
        "https://i.ibb.co/V0FRB8VY/1765397132500-1.png"
    ];

    const FALLBACK_COLORS = ['#222222', '#555555', '#BBBBBB', '#0044BB', '#770000', '#006600', '#AA9900'];
    
    // LISTE DES VOITURES NORMALES
    let carsData = [
        { name: "PEUGEOT 205 T16", src: "https://i.ibb.co/v6QhzC0v/1765324109186-ezgif-com-png-to-jpg-converter.png", speedFactor: 10, handling: 0.9, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ" },
        { name: "PORSCHE 911",     src: "https://i.ibb.co/qfJh4D1/1765324109186-ezgif-com-crop-2.png", speedFactor: 14, handling: 1.1, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ" },
        { name: "BMW E30",         src: "https://i.ibb.co/ch46FTBY/1765324109186-ezgif-com-crop-3.png", speedFactor: 12, handling: 0.8, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ" },
        { name: "MERCEDES SL",     src: "https://i.ibb.co/nqNZ1h26/1765324109186-ezgif-com-crop.png", speedFactor: 11, handling: 0.7, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñØ‚ñØ‚ñØ" },
        { name: "AUDI QUATTRO",    src: "https://i.ibb.co/4Z5kVGxD/1765324109186-ezgif-com-crop-1.png", speedFactor: 11, handling: 1.0, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ" },
        { name: "RENAULT 5 TURBO", src: "https://i.ibb.co/gLpfpKx5/1765324109186-ezgif-com-crop-4.png", speedFactor: 9, handling: 1.2, descSpeed: "‚ñÆ‚ñÆ‚ñØ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ" },
        { name: "SL D'ALEX", src: "https://i.ibb.co/sdL9DB3b/1765333831273-1.png", speedFactor: 13, handling: 0.8, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ" },
        { name: "BOXSTER S 986 D'ALEX", src: "https://i.ibb.co/xtsYpCK5/1765333831273-2-1.png", speedFactor: 13, handling: 1.2, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ" },
        { name: "FERRARI TESTAROSSA", src: "https://i.ibb.co/6RY19XVR/1765336708745.png", speedFactor: 14, handling: 1.1, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñØ" },
        { name: "SHELBY GT500 ELEANOR", src: "https://i.ibb.co/pBSQNMM3/thumbnail-1765469042532.png", speedFactor: 15, handling: 0.85, descSpeed: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñØ‚ñØ" },
        { name: "FOURMI ACROMY", src: "https://i.ibb.co/3Z8zLGX/1765462278497.png", speedFactor: 5, handling: 1.5, descSpeed: "‚ñÆ‚ñØ‚ñØ‚ñØ‚ñØ", descHand: "‚ñÆ‚ñÆ‚ñÆ‚ñÆ‚ñÆ+" }
    ];

    // DEFINITION DES MODES VIP ET LEURS VOITURES
    const vipModes = [
        { id: "POLICE", name: "BAC (POLICE)", desc: "NOS ILLIMIT√â", carName: "M√âGANE R.S. BAC", src: "https://i.ibb.co/4wPy50J0/1000027506.png", speed: 16, hand: 1.2, actionText: "NOS ‚àû" },
        { id: "BULLDOZER", name: "BULLDOZER", desc: "D√âTRUIS LES VOITURES", carName: "HUMMER H2", src: "https://i.ibb.co/23dzfm0K/1000027510.png", speed: 12, hand: 0.6, actionText: "SMASH" },
        { id: "SPECTRE", name: "SPECTRE", desc: "PHASE (INTANGIBLE)", carName: "DELOREAN", src: "https://i.ibb.co/LDY8Fq9g/1000027502.png", speed: 14, hand: 1.0, actionText: "PHASE" },
        { id: "GOLDEN", name: "GOLDEN BOY", desc: "SCORE X2", carName: "CYBERPUNK", src: "https://i.ibb.co/QFDwsVZf/1000027503.png", speed: 18, hand: 1.1, actionText: "SCORE X2" },
        { id: "BOND", name: "007", desc: "TIRE DES MISSILES", carName: "ASTON MARTIN", src: "https://i.ibb.co/dsPXPDST/1000027505.png", speed: 15, hand: 1.0, actionText: "FEU" },
        { id: "JUMP", name: "K-2000", desc: "SAUTE PAR DESSUS", carName: "K.I.T.T.", src: "https://i.ibb.co/0v5GsRq/1000027504.png", speed: 16, hand: 1.2, actionText: "SAUT" },
        { id: "MICRO", name: "MICRO", desc: "TOUT PETIT (HITBOX)", carName: "MINI COOPER", src: "https://i.ibb.co/N2TRNfKb/1000027507.png", speed: 13, hand: 1.6, actionText: "NOS" },
        { id: "RETRO", name: "RETRO", desc: "10 VIES AU D√âPART", carName: "FERRARI OUTRUN", src: "https://i.ibb.co/jZJFksHD/1000027508.png", speed: 14, hand: 1.0, actionText: "10 VIES" }
    ];

    let currentVipMode = null;

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const distEl = document.getElementById('distVal');
    const heartsEl = document.getElementById('hearts');
    const timerEl = document.getElementById('timer');
    const photoScoreEl = document.getElementById('photoScore');
    const menuScreen = document.getElementById('menuScreen');
    const leaderboardScreen = document.getElementById('leaderboardScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const instructionsScreen = document.getElementById('instructionsScreen');
    const vipLoginScreen = document.getElementById('vipLoginScreen');
    const vipMenuScreen = document.getElementById('vipMenuScreen');
    const pauseScreen = document.getElementById('pauseScreen');
    const pauseBtn = document.getElementById('pause-btn');
    const vipGrid = document.getElementById('vipGrid');
    const speedValEl = document.getElementById('speedVal');
    const goDistanceEl = document.getElementById('goDistance');
    const goBonusEl = document.getElementById('goBonus');
    const goFinalScoreEl = document.getElementById('goFinalScore');
    const nameInputEl = document.getElementById('nameInput');
    const goTitleEl = document.getElementById('gameOverTitle');
    const carNameEl = document.getElementById('carName');
    const pCanvas = document.getElementById('previewCanvas');
    const pCtx = pCanvas.getContext('2d');
    const statSpeedEl = document.getElementById('statSpeed');
    const statHandEl = document.getElementById('statHand');
    const nosContainer = document.getElementById('nos-container');
    const nosBarFill = document.getElementById('nos-bar-fill');
    const nosBtn = document.getElementById('nos-btn');
    const brakeBtn = document.getElementById('brake-btn');
    const alertMsg = document.getElementById('alert-msg');
    const photoGradeMsg = document.getElementById('photo-grade');
    const flashOverlay = document.getElementById('flash-overlay');
    const scoreList = document.getElementById('scoreList');
    const highScoreZone = document.getElementById('highScoreZone');
    const submitBtn = document.getElementById('submitBtn');
    
    // NOUVELLE R√âF√âRENCE POUR LE MOT DE PASSE
    const vipPasswordInputEl = document.getElementById('vipPasswordInput'); 

    const vipErrorEl = document.getElementById('vipError');
    const vipSuccessEl = document.getElementById('vipSuccess');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    pCanvas.width = 140; pCanvas.height = 180;

    ctx.imageSmoothingEnabled = false;
    pCtx.imageSmoothingEnabled = false;

    const bgImage = new Image(); bgImage.src = BG_URL;
    const truckImage = new Image(); truckImage.src = TRUCK_URL;
    const spottersImage = new Image(); spottersImage.src = SPOTTERS_URL;
    
    const enemyImages = ENEMY_SPRITE_URLS.map(url => {
        const img = new Image();
        img.src = url;
        return img;
    });
    
    let currentCarIndex = 0;
    const loadedImages = [];
    
    function loadCarImages() {
        carsData.forEach((data, index) => {
            const img = new Image(); img.src = data.src;
            img.onload = () => { if(index === currentCarIndex && !currentVipMode) updateMenu(); };
            loadedImages[index] = img;
        });
        // Charger aussi les images VIP
        vipModes.forEach(mode => {
            const img = new Image(); img.src = mode.src;
            img.onload = () => { if(currentVipMode && currentVipMode.id === mode.id) updateMenu(); };
            mode.imgObj = img;
        });
    }
    loadCarImages();

    function drawRotated(context, img, x, y, width, height, angleDegrees, opacity = 1) {
        if (!img.complete) {
            context.save(); context.fillStyle = "red"; context.fillRect(x, y, width, height); context.restore(); return;
        }
        context.save();
        context.globalAlpha = opacity;
        context.translate(x + width / 2, y + height / 2);
        context.rotate(angleDegrees * Math.PI / 180);
        context.drawImage(img, -width / 2, -height / 2, width, height);
        context.restore();
    }
    
    function updateMenu() {
        if (currentVipMode) {
             const mode = currentVipMode;
             carNameEl.innerText = mode.carName + " (" + mode.id + ")";
             carNameEl.style.color = "#ffff00"; carNameEl.style.textShadow = "0 0 10px orange";
             statSpeedEl.innerText = mode.descSpeed || "N/A";
             statHandEl.innerText = mode.descHand || "N/A";
             pCtx.clearRect(0, 0, pCanvas.width, pCtx.canvas.height); 
             const previewW = 45; const previewH = 95;
             drawRotated(pCtx, mode.imgObj, (pCanvas.width-previewW)/2, (pCanvas.height-previewH)/2, previewW, previewH, ROTATION_ANGLE);
             return;
        }
        const car = carsData[currentCarIndex];
        carNameEl.innerText = car.name;
        statSpeedEl.innerText = car.descSpeed;
        statHandEl.innerText = car.descHand;
        carNameEl.style.color = "#00ffff";
        carNameEl.style.textShadow = "2px 2px 0px #ff00ff";
        pCtx.clearRect(0, 0, pCanvas.width, pCtx.canvas.height);
        const previewW = 45; const previewH = 95;
        drawRotated(pCtx, loadedImages[currentCarIndex], (pCanvas.width-previewW)/2, (pCanvas.height-previewH)/2, previewW, previewH, ROTATION_ANGLE);
    }

    window.changeCar = function(dir) {
        currentVipMode = null; 
        currentCarIndex += dir;
        if(currentCarIndex < 0) currentCarIndex = carsData.length - 1;
        if(currentCarIndex >= carsData.length) currentCarIndex = 0;
        updateMenu();
    };

    window.showInstructions = function() {
        menuScreen.style.display = 'none';
        instructionsScreen.style.display = 'flex';
    }

    window.closeInstructions = function() {
        instructionsScreen.style.display = 'none';
        menuScreen.style.display = 'flex';
    }

    // --- GESTION LOGIN & MENU VIP SIMPLIFI√âE ---
    window.showVipLogin = function() { 
        menuScreen.style.display = 'none'; 
        vipLoginScreen.style.display = 'flex'; 
        vipErrorEl.style.display = 'none'; 
        vipSuccessEl.style.display = 'none';
        vipPasswordInputEl.value = '';
    }
    window.closeVipLogin = function() { vipLoginScreen.style.display = 'none'; menuScreen.style.display = 'flex'; }

    // AUTHENTIFICATION SIMPLIFI√âE (MOT DE PASSE HARDCOD√â)
    window.loginVipUser = function() {
        const password = vipPasswordInputEl.value.toUpperCase().trim();
        vipErrorEl.style.display = 'none'; 
        vipSuccessEl.style.display = 'none';

        if(password.length === 0) {
            vipErrorEl.innerText = "Veuillez entrer le mot de passe.";
            vipErrorEl.style.display = 'block';
            return;
        }

        if (password === VIP_PASSWORD) {
            alert("Connexion VIP r√©ussie !");
            // Utiliser un jeton de session factice
            llSessionToken = `VIP_SESSION_${Math.random().toString(36).substring(2, 9)}`; 
            showVipMenu();
            return;
        }
        
        // Si la v√©rification √©choue
        vipErrorEl.innerText = "Mot de passe incorrect.";
        vipErrorEl.style.display = 'block';
    }

    function showVipMenu() {
        vipLoginScreen.style.display = 'none';
        vipMenuScreen.style.display = 'flex';
        
        currentVipMode = null;
        
        vipGrid.innerHTML = "";
        vipModes.forEach(mode => {
            let card = document.createElement("div");
            card.className = "vip-card";
            card.innerHTML = `<img src="${mode.src}" style="width:50px; height:50px; object-fit:contain; filter: drop-shadow(0 0 5px #ff00ff);"><h4 style="color:#ffff00">${mode.name}</h4><span>${mode.desc}</span>`;
            card.onclick = () => selectVipMode(mode);
            vipGrid.appendChild(card);
        });
    }

    window.closeVipMenu = function() { vipMenuScreen.style.display = 'none'; menuScreen.style.display = 'flex'; }

    // --- CORRECTION DU BUG VIP ICI ---
    function selectVipMode(mode) {
        currentVipMode = mode;
        updateMenu();

        alert("MODE " + mode.name + " S√âLECTIONN√â ! Pr√™t √† d√©marrer.");
        vipMenuScreen.style.display = 'none';
        
        // R√©afficher le menu principal pour lancer le jeu
        menuScreen.style.display = 'flex';
    }

    // --- FONCTIONS LOOTLOCKER (Standard) ---
    async function initLootLocker() {
        try { const response = await fetch('https://api.lootlocker.io/game/v2/session/guest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_key: LL_API_KEY, game_version: "1.0.0" })
            });
            const data = await response.json();
            if(data.session_token) llSessionToken = data.session_token;
        } catch(e) { 
            console.error("Initialisation Guest Session LootLocker √©chou√©e. Classement indisponible.", e);
        }
    }
    initLootLocker();

    async function getScores() {
        if(!llSessionToken) { await initLootLocker(); } 
        if(!llSessionToken || llSessionToken.startsWith("VIP_SESSION_")) return []; 
        
        try { const response = await fetch(`https://api.lootlocker.io/game/leaderboards/${LL_LEADERBOARD_ID}/list?count=10`, { method: 'GET', headers: { 'x-session-token': llSessionToken, 'Content-Type': 'application/json' } }); const data = await response.json(); if(data && data.items) return data.items.map(i => ({ name: i.metadata || "Pilote", score: i.score })); return []; } catch (e) { return []; }
    }

    async function saveScore(name, dist) {
        submitBtn.innerText = "ENVOI..."; submitBtn.disabled = true;
        if(!llSessionToken) { await initLootLocker(); }
        
        if(!llSessionToken || llSessionToken.startsWith("VIP_SESSION_")) { 
            submitBtn.innerText = "SCORE NON ENVOY√â (MODE VIP)";
            submitBtn.disabled = false; 
            return;
        }
        
        let cleanName = name.replace(/[^a-zA-Z0-9 ]/g, "").substring(0, 10) || "Anonyme";
        let scoreToSend = Math.floor(parseFloat(goFinalScoreEl.innerText) * 10); 
        try { await fetch(`https://api.lootlocker.io/game/leaderboards/${LL_LEADERBOARD_ID}/submit`, { method: 'POST', headers: { 'x-session-token': llSessionToken, 'Content-Type': 'application/json' }, body: JSON.stringify({ score: scoreToSend, metadata: cleanName }) }); submitBtn.innerText = "SCORE ENVOY√â !"; } catch(e) { submitBtn.innerText = "ERREUR"; submitBtn.disabled = false; }
    }

    async function showLeaderboard() {
        menuScreen.style.display = 'none'; leaderboardScreen.style.display = 'flex';
        scoreList.innerHTML = "<tr><td colspan='3'>Chargement...</td></tr>";
        let scores = await getScores(); scoreList.innerHTML = "";
        if(scores.length === 0) scoreList.innerHTML = "<tr><td colspan='3'>Classement indisponible ou vide.</td></tr>";
        else scores.forEach((s, i) => { scoreList.innerHTML += `<tr><td>#${i+1}</td><td>${s.name}</td><td>${(s.score/10).toFixed(1)} km</td></tr>`; });
    }
    window.closeLeaderboard = function() { leaderboardScreen.style.display = 'none'; menuScreen.style.display = 'flex'; };
    window.submitScore = function() { saveScore(nameInputEl.value.toUpperCase().substring(0, 10) || "ANONYME", 0); }

    // VARIABLES JEU
    let gameRunning = false;
    let isPaused = false; // VARIABLE PAUSE
    let distance = 0;
    let speed = 10;
    let targetSpeed = 10; 
    let baseSpeed = 10; 
    let handling = 0.8;
    let startTime;
    let difficultyInterval;
    let elapsedTime = 0;
    let lives = 3;
    let isInvincible = false;
    let invincibilityTimer = 0;

    let nosLevel = 0; 
    let isNosActive = false;
    let nosEndTime = 0;
    let isBraking = false;
    let brakeEndTime = 0; 
    let brakeCooldownEndTime = 0;

    let currentLevel = 1;
    let levelEvents = []; 
    let lastLevelEvents = [];
    let isWarningActive = false; 
    
    // VARIABLES EVENTS
    let isTunnelActive = false; let tunnelEndTime = 0;
    let isFogActive = false; let fogEndTime = 0;
    let isIceActive = false; let iceEndTime = 0;
    let isWorkActive = false; let workEndTime = 0;
    let isStormActive = false; let stormEndTime = 0;
    let lightningState = 0; let lightningNextStrike = 0; let lightningTimer = 0; let lightningLane = 0;
    
    // VARIABLES PHOTO (MODIFI√âES POUR LE SCORE GRADUEL)
    let isPhotoActive = false; 
    let photoZoneY = -1000; 
    let photoBonusScore = 0; 
    let isPosing = false; 
    let spotterStopPointY = 0;
    let currentGrade = "B"; 
    let currentPointsObj = 0;

    // --- VARIABLES VIP SPECIFIQUES ---
    let projectiles = [];
    let isJumping = false;
    let jumpEndTime = 0;
    let hasExtraLives = false;
    // --- BOND (007) VARIABLES ---
    let bondAmmo = 15;
    let bondOvertakeCount = 0;

    let radars = [];
    let cones = [];
    let player = { x: 0, y: 0, targetX: 0, laneIndex: 1 }; 
    let obstacles = [];
    let bonuses = [];
    let roadLines = [];

    const ROAD_WIDTH_PCT = 0.50; 
    const ROAD_WIDTH = canvas.width * ROAD_WIDTH_PCT;
    const ROAD_LEFT = (canvas.width - ROAD_WIDTH) / 2; 
    const ROAD_RIGHT = ROAD_LEFT + ROAD_WIDTH;
    const LANE_WIDTH = ROAD_WIDTH / 3;

    function lerp(start, end, amt){ return (1-amt)*start+amt*end }

    // GESTION CLAVIER (PC)
    document.addEventListener('keydown', function(e) {
        if(!gameRunning || isPosing || isPaused) return;

        // FLECHE GAUCHE
        if(e.code === 'ArrowLeft') {
            if(player.laneIndex > 0) player.laneIndex--;
            player.targetX = getLaneX(player.laneIndex);
        }
        // FLECHE DROITE
        if(e.code === 'ArrowRight') {
            if(player.laneIndex < 2) player.laneIndex++;
            player.targetX = getLaneX(player.laneIndex);
        }
        // TOUCHE A = FREIN
        if(e.code === 'KeyA') {
            triggerBrake(e);
        }
        // TOUCHE Z (AZERTY SUPPORT)
        // On v√©rifie la lettre 'z' (touche Z sur azerty, W sur qwerty)
        if(e.key.toLowerCase() === 'z') {
            activateNOS(e);
        }
    });

    function handleTap(e) {
        if(!gameRunning || isPosing || isPaused) return;
        if(e.target.id === 'nos-btn' || e.target.parentNode.id === 'nos-container' || e.target.id === 'brake-btn' || e.target.id === 'pause-btn') return;
        e.preventDefault(); 
        let isControl = (e.target.closest('#brake-btn') || e.target.closest('#nos-container') || e.target.closest('#pause-btn'));
        if (isControl) return;
        let touchX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        let screenCenter = window.innerWidth / 2;
        if (touchX < screenCenter) { if(player.laneIndex > 0) player.laneIndex--; } 
        else { if(player.laneIndex < 2) player.laneIndex++; }
        player.targetX = getLaneX(player.laneIndex);
    }

    canvas.addEventListener('touchstart', handleTap, {passive: false});
    canvas.addEventListener('mousedown', handleTap);
    
    // GESTION PAUSE
    window.togglePause = function() {
        if(!gameRunning) return;
        isPaused = !isPaused;
        
        if(isPaused) {
            pauseScreen.style.display = 'flex';
        } else {
            pauseScreen.style.display = 'none';
            // On relance la boucle
            loop();
        }
    };

    window.triggerBrake = function(e) { 
        if(e) { e.stopPropagation(); e.preventDefault(); }
        let now = Date.now();
        if (isBraking || now < brakeCooldownEndTime || isPaused) return;
        
        isBraking = true;
        brakeEndTime = now + BRAKE_DURATION_MS; 
        brakeBtn.classList.add('active'); 

        // --- NOUVELLE LOGIQUE ZONE PHOTO ---
        if (isPhotoActive && !isPosing) {
             // Calcul de l'√©cart (distance absolue) entre la voiture et le centre de la zone
             let diff = Math.abs(photoZoneY - player.y);
             
             // Si on est dans la zone large (Rouge ou mieux)
             if (diff < 150) { 
                if (diff < 40) {
                    // ZONE VERTE (Tr√®s pr√©cis)
                    currentGrade = "S - L√âGENDAIRE !";
                    currentPointsObj = 1000;
                } else if (diff < 90) {
                    // ZONE ORANGE (Moyen)
                    currentGrade = "A - EXCELLENT";
                    currentPointsObj = 500;
                } else {
                    // ZONE ROUGE (Juste au bord)
                    currentGrade = "B - PAS MAL";
                    currentPointsObj = 100;
                }
                startPhotoPose(); 
             }
        }
    };

    window.activateNOS = function(e) {
        if(e) { e.stopPropagation(); e.preventDefault(); }
        if(isPaused) return;
        
        if(currentVipMode && currentVipMode.id === "JUMP" && !isJumping) {
            isJumping = true; jumpEndTime = Date.now() + 1500;
            return;
        }
        
        // --- LOGIQUE JAMES BOND (15 missiles, un par un) ---
        if(currentVipMode && currentVipMode.id === "BOND") {
            if (bondAmmo > 0) {
                // On cr√©e 1 missile
                projectiles.push({x: player.x + CAR_W/2 - 5, y: player.y, w: 10, h: 20});
                // On enl√®ve 1 munition
                bondAmmo--;
                // Mise √† jour imm√©diate du bouton
                nosBtn.innerText = bondAmmo;
            }
            return; // On arr√™te la fonction ici
        }
        // -------------------------------------------------------------

        if(currentVipMode && currentVipMode.id === "SPECTRE" && nosLevel >= 100) {
            isInvincible = true; invincibilityTimer = Date.now() + 3000;
            nosLevel = 0;
            nosBarFill.style.width = "0%";
            nosBtn.classList.remove('ready');
            return;
        }

        let canActivate = (nosLevel >= 100) || (currentVipMode && currentVipMode.id === "POLICE");
        
        if (canActivate && !isNosActive && !isPosing) {
            isNosActive = true; 
            if(!currentVipMode || currentVipMode.id !== "POLICE") { nosLevel = 0; nosBarFill.style.width = "0%"; nosBtn.classList.remove('ready'); }
            targetSpeed = baseSpeed + 20; 
            nosEndTime = Date.now() + 5000; 
        }
    };

    function startPhotoPose() {
        isPosing = true; isInvincible = true; speed = 0; targetSpeed = 0;
        showAlert("POSEZ POUR LA PHOTO !", "#ff00ff", "black");
        let flashInterval = setInterval(() => { if(!isPosing) { clearInterval(flashInterval); return; } triggerSpotterFlash(); }, 300 + Math.random() * 500);
        setTimeout(() => { clearInterval(flashInterval); calculateAndShowPhotoScore(); }, 3000);
    }

    function calculateAndShowPhotoScore() {
        let scoreMult = (currentVipMode && currentVipMode.id === "GOLDEN") ? 2 : 1;
        
        // On r√©cup√®re les valeurs calcul√©es lors du freinage
        let grade = currentGrade; 
        let pts = currentPointsObj * scoreMult; 
        
        // Couleur du texte selon le grade
        let color = "#00ff00"; // Vert par d√©faut (S)
        if(currentPointsObj === 500) color = "orange"; // (A)
        if(currentPointsObj === 100) color = "#ff3333"; // (B)

        photoBonusScore += pts; 
        photoScoreEl.innerText = photoBonusScore;
        
        photoGradeMsg.innerText = grade; 
        photoGradeMsg.style.color = color; 
        photoGradeMsg.style.display = "block"; 
        
        triggerFlash(); 
        
        setTimeout(() => { 
            photoGradeMsg.style.display = "none"; 
            isPosing = false;
            isPhotoActive = false; 
            targetSpeed = baseSpeed; 
            showAlert("C'EST REPARTI !", "lime", "black");
            invincibilityTimer = Date.now() + 2000; 
        }, 2000);
    }
    
    function triggerSpotterFlash() {
        let flash = document.createElement('div'); flash.className = 'spotter-flash';
        flash.style.left = (Math.random() * ROAD_LEFT) + 'px'; flash.style.top = (photoZoneY + Math.random() * 300) + 'px';
        flash.style.width = (20 + Math.random()*30) + 'px'; flash.style.height = flash.style.width;
        document.body.appendChild(flash);
        flash.animate([{ opacity: 0, transform: 'scale(0.5)' }, { opacity: 1, transform: 'scale(1.5)' }, { opacity: 0, transform: 'scale(0.8)' }], { duration: 150 + Math.random()*150, easing: 'ease-out' }).onfinish = () => { flash.remove(); };
    }

    window.startGame = function() {
        menuScreen.style.display = 'none'; leaderboardScreen.style.display = 'none';
        gameOverScreen.style.display = 'none'; instructionsScreen.style.display = 'none';
        vipLoginScreen.style.display = 'none'; vipMenuScreen.style.display = 'none';
        pauseScreen.style.display = 'none';

        brakeBtn.style.display = 'flex'; brakeBtn.classList.remove('cooldown', 'active'); 
        nosContainer.style.display = 'flex'; 
        pauseBtn.style.display = 'block'; // AFFICHER BOUTON PAUSE

        nosLevel = 0; nosBarFill.style.width = "0%"; nosBtn.classList.remove('ready');

        if(currentVipMode) {
             baseSpeed = currentVipMode.speed;
             handling = currentVipMode.hand;
             nosBtn.innerText = currentVipMode.actionText;
             nosBtn.style.fontSize = "14px";
             
             // GESTION BOND (MUNITIONS)
             if(currentVipMode.id === "BOND") { 
                 bondAmmo = 15; 
                 bondOvertakeCount = 0;
                 nosBtn.classList.add('ready'); 
                 nosBarFill.style.width = "0%"; // Barre vide au d√©part (progression recharge)
                 nosBtn.innerText = bondAmmo;
             }
             
             else if(currentVipMode.id === "POLICE") { nosLevel = 100; nosBarFill.style.width = "100%"; nosBtn.classList.add('ready'); }
             else if(currentVipMode.id === "RETRO") { lives = 10; hasExtraLives = true; }
             else { lives = 3; hasExtraLives = false; }
             
             if(["JUMP", "SPECTRE"].includes(currentVipMode.id)) { nosBtn.classList.add('ready'); nosLevel = 100; nosBarFill.style.width = "100%"; }
        } else {
             baseSpeed = carsData[currentCarIndex].speedFactor;
             handling = carsData[currentCarIndex].handling;
             nosBtn.innerText = "NOS"; nosBtn.style.fontSize = "24px";
             lives = 3; hasExtraLives = false;
        }

        distance = 0; updateHearts(); isInvincible = false;
        targetSpeed = baseSpeed + (Math.random() * 0.5) - 0.25; speed = targetSpeed;
        
        lightningState = 0; lightningNextStrike = 0; lightningTimer = 0; lightningLane = 0;
        isNosActive = false; photoBonusScore = 0; photoScoreEl.innerText = "0";
        obstacles = []; bonuses = []; roadLines = []; radars = []; cones = []; projectiles = [];
        
        isTunnelActive = false; isFogActive = false; isIceActive = false; isWorkActive = false; isStormActive = false; isPhotoActive = false;
        isWarningActive = false; isPosing = false; isPaused = false;
        isBraking = false; brakeCooldownEndTime = 0; brakeEndTime = 0;
        isJumping = false;

        currentLevel = 1; lastLevelEvents = []; pickLevelEvents(); 
        elapsedTime = 0; startTime = Date.now();
        
        player.laneIndex = 1; player.targetX = getLaneX(player.laneIndex);
        player.x = player.targetX; player.y = canvas.height - 150; 
        
        gameRunning = true;
        if(difficultyInterval) clearInterval(difficultyInterval);
        loop();

        difficultyInterval = setInterval(() => {
            if(!gameRunning || isPosing || isPaused) return;
            let levelCheck = Math.floor((Date.now() - startTime) / 45000) + 1;
            if(levelCheck > currentLevel) {
                currentLevel = levelCheck;
                
                // --- LOGIQUE REGAIN DE VIE (MAX 3) ---
                let lifeMsg = "";
                if(lives < (hasExtraLives ? 10 : 3)) { // V√©rifie si on a moins que le max (3 ou 10 si Retro)
                    lives++;
                    updateHearts();
                    lifeMsg = " (+1 ‚ù§Ô∏è)";
                }
                // -------------------------------------

                if(!isNosActive && !isBraking) { targetSpeed += 2; baseSpeed += 2; }
                showAlert("NIVEAU " + currentLevel + " !" + lifeMsg, "orange", "black");
                pickLevelEvents(); 
            }
            if(Math.random() < 0.08 && !isEventActive() && !isWarningActive) { warnAndTriggerEvent(); }
        }, 1000); 

        setInterval(() => {
            if(!gameRunning || isPosing || isPaused) return;
            if(obstacles.length >= 2) return;
            let blockedLane = -1;
            if(isWorkActive && cones.length > 0) blockedLane = cones[0].lane;
            let laneIndex = Math.floor(Math.random() * 3);
            if(laneIndex === blockedLane) return;
            let safeToSpawn = true;
            if(obstacles.length > 0) {
                 let lastObs = obstacles[obstacles.length - 1];
                 if(lastObs.y < -50) safeToSpawn = false;
                 if(Math.abs(lastObs.x - getLaneX(laneIndex)) < 10) safeToSpawn = false;
            }
            if(safeToSpawn) {
                let obsX = getLaneX(laneIndex);
                const randomSpriteIndex = Math.floor(Math.random() * enemyImages.length); 
                let enemyFactor = 0.4 + Math.random() * 0.4;
                if(currentVipMode && currentVipMode.id === "MICRO" && Math.random() > 0.5) { obsX += (Math.random() > 0.5 ? 20 : -20); }
                obstacles.push({ x: obsX, y: -150, img: enemyImages[randomSpriteIndex], factor: enemyFactor, lane: laneIndex });
            }
        }, 800); 

        setInterval(() => {
            if(!gameRunning || isPosing || isPaused) return;
            if(lives < (hasExtraLives ? 10 : 3) && Math.random() < 0.2) {
                let laneIndex = Math.floor(Math.random() * 3);
                let safe = true;
                obstacles.forEach(o => { if(Math.abs(o.x - getLaneX(laneIndex)) < 10 && o.y < 0) safe = false; });
                if(safe) bonuses.push({ x: getLaneX(laneIndex) + (CAR_W/2) - 15, y: -150, w: 30, h: 30 });
            }
        }, 3000);
        setInterval(() => { if(!gameRunning || isPosing || isPaused) return; roadLines.push({x: canvas.width/2 - 5, y: -50}); }, 150);
    };

    async function gameOver(crashType = 'CRASH') {
        gameRunning = false; 
        nosContainer.style.display = 'none'; brakeBtn.style.display = 'none'; pauseBtn.style.display = 'none';
        
        const finalScore = parseFloat(distance.toFixed(1)) + (photoBonusScore / 100);
        goDistanceEl.innerText = finalScore.toFixed(2) + " km";
        goBonusEl.innerText = photoBonusScore;
        goFinalScoreEl.innerText = finalScore.toFixed(2);
        
        nameInputEl.value = ""; highScoreZone.style.display = "none"; submitBtn.disabled = false; submitBtn.innerText = "VALIDER LE SCORE";
        if (crashType === 'FLASH') { goTitleEl.innerText = "PERMIS RETIR√â ! (FLASH√â)"; goTitleEl.style.color = "#00ffff"; } 
        else { goTitleEl.innerText = "T'A BROYER L'AUTO !"; goTitleEl.style.color = "#ff0000"; }
        gameOverScreen.style.display = 'flex';

        try {
            let scores = await getScores();
            let finalScoreInt = Math.floor(finalScore * 10); 
            let isTop10 = scores.length < 10 || finalScoreInt > scores[scores.length - 1].score;
            if (isTop10) { highScoreZone.style.display = "flex"; }
        } catch (e) {}
    }

    function pickLevelEvents() {
        if(Math.random() < 0.30) { levelEvents = []; lastLevelEvents = []; showAlert("ROUTE D√âGAG√âE...", "lime", "black"); return; }
        const allEvents = ['TUNNEL', 'RADAR', 'FOG', 'ICE', 'WORK', 'STORM', 'TRUCK', 'PHOTO'];
        const availableEvents = allEvents.filter(e => !lastLevelEvents.includes(e));
        levelEvents = availableEvents.sort(() => 0.5 - Math.random()).slice(0, (currentLevel === 1) ? 1 : 2);
        lastLevelEvents = levelEvents;
    }
    function isEventActive() { return isTunnelActive || isFogActive || isIceActive || isWorkActive || isStormActive || isPhotoActive; }
    function warnAndTriggerEvent() {
        if (levelEvents.length === 0) return;
        let eventType = levelEvents[Math.floor(Math.random() * levelEvents.length)];
        isWarningActive = true;
        let eventName = ""; let color = "white";
        if(eventType === 'TUNNEL') { eventName = "TUNNEL"; color = "yellow"; }
        else if(eventType === 'RADAR') { eventName = "ZONE RADAR"; color = "cyan"; }
        else if(eventType === 'FOG') { eventName = "BROUILLARD"; color = "#ccc"; }
        else if(eventType === 'ICE') { eventName = "VERGLAS"; color = "cyan"; }
        else if(eventType === 'WORK') { eventName = "TRAVAUX"; color = "orange"; }
        else if(eventType === 'STORM') { eventName = "ORAGE VIOLENT"; color = "purple"; }
        else if(eventType === 'TRUCK') { eventName = "CONVOI EXCEPTIONNEL"; color = "pink"; }
        else if(eventType === 'PHOTO') { eventName = "SPOTTERS ! PR√âPARE TOI"; color = "#ff00ff"; }
        showAlert("‚ö†Ô∏è " + eventName + " DANS 3s ‚ö†Ô∏è", color, "black");
        setTimeout(() => { isWarningActive = false; if (eventType === 'STORM') { lightningNextStrike = Date.now() + 1000; lightningState = 0; } launchEventEffect(eventType); }, 3000);
    }
    function launchEventEffect(eventType) {
        let duration = 6000 + (currentLevel * 1500); 
        if(eventType === 'TUNNEL') { isTunnelActive = true; tunnelEndTime = Date.now() + duration; } 
        else if(eventType === 'RADAR') { spawnRadar(); }
        else if(eventType === 'FOG') { isFogActive = true; fogEndTime = Date.now() + duration; }
        else if(eventType === 'ICE') { isIceActive = true; iceEndTime = Date.now() + duration; }
        else if(eventType === 'WORK') { isWorkActive = true; workEndTime = Date.now() + duration; startRoadWorks(); }
        else if(eventType === 'STORM') { isStormActive = true; stormEndTime = Date.now() + duration; }
        else if(eventType === 'TRUCK') { spawnTruck(); }
        else if(eventType === 'PHOTO') { isPhotoActive = true; photoZoneY = -600; spotterStopPointY = canvas.height - 250; }
    }
    function spawnRadar() { radars.push({ x: ROAD_RIGHT + 5, y: -50, passed: false }); }
    function startRoadWorks() { let lane = Math.floor(Math.random() * 3); for(let i=0; i<6; i++) { cones.push({ x: getLaneX(lane) + CAR_W/2 - 15, y: -100 - (i*150), lane: lane }); } }
    function spawnTruck() { let laneIndex = Math.floor(Math.random() * 3); let obsX = getLaneX(laneIndex) - 7.5; obstacles.push({ x: obsX, y: -300, type: 'truck', w: 60, h: 240, img: truckImage, factor: 0.5, lane: laneIndex }); }
    function showAlert(text, color, bg) { alertMsg.innerText = text; alertMsg.style.color = color; alertMsg.style.backgroundColor = bg; alertMsg.style.display = "block"; setTimeout(() => { alertMsg.style.display = "none"; }, 2500); }
    function triggerFlash() { flashOverlay.style.opacity = 1; setTimeout(() => { flashOverlay.style.opacity = 0; }, 150); }
    function getLaneX(laneIndex) { return ROAD_LEFT + (laneIndex * LANE_WIDTH) + (LANE_WIDTH - CAR_W) / 2; }
    function formatTime(ms) { let totalSeconds = Math.floor(ms / 1000); let minutes = Math.floor(totalSeconds / 60); let seconds = totalSeconds % 60; return (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds); }
    function updateHearts() { let h = ""; for(let i=0; i<lives; i++) h += "‚ù§Ô∏è"; for(let i=lives; i<(currentVipMode && currentVipMode.id === "RETRO" ? 10 : 3); i++) h += "üñ§"; heartsEl.innerText = h; }
    function drawLightning(x) { ctx.beginPath(); ctx.strokeStyle = "#aaddff"; ctx.lineWidth = 3; ctx.shadowBlur = 20; ctx.shadowColor = "white"; ctx.moveTo(x, 0); let currentY = 0; let currentX = x; while(currentY < canvas.height) { currentY += Math.random() * 30 + 10; currentX += (Math.random() - 0.5) * 40; ctx.lineTo(currentX, currentY); } ctx.stroke(); ctx.shadowBlur = 0; }

    function loop() {
        if(!gameRunning) return;
        if(isPaused) return; // ARRET BOUCLE SI PAUSE

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let now = Date.now();

        if(isTunnelActive && now > tunnelEndTime) isTunnelActive = false;
        if(isFogActive && now > fogEndTime) isFogActive = false;
        if(isIceActive && now > iceEndTime) isIceActive = false;
        if(isWorkActive && now > workEndTime && cones.length === 0) isWorkActive = false;
        if(isStormActive && now > stormEndTime) isStormActive = false;
        
        if(isJumping && now > jumpEndTime) isJumping = false;

        if(isPosing) { drawGameStatic(); requestAnimationFrame(loop); return; }

        if (isBraking) {
            if (now > brakeEndTime) { isBraking = false; brakeCooldownEndTime = now + BRAKE_COOLDOWN_MS; brakeBtn.classList.remove('active'); brakeBtn.classList.add('cooldown'); }
        } else {
            if (now > brakeCooldownEndTime) { brakeBtn.classList.remove('cooldown'); } else { brakeBtn.classList.add('cooldown'); }
        }

        if (isNosActive) {
            if (now > nosEndTime) { isNosActive = false; targetSpeed = baseSpeed; nosContainer.style.display = 'flex'; }
        } else {
            if (isBraking) { targetSpeed = baseSpeed * 0.4; if (targetSpeed < 3) targetSpeed = 3; } 
            else { targetSpeed = baseSpeed + (Math.random() * 0.6); }
        }

        speed = lerp(speed, targetSpeed, 0.1); 
        
        // --- GESTION MUNITIONS JAMES BOND (AFFICHAGE) ---
        if(currentVipMode && currentVipMode.id === "BOND") {
            // Affichage sur le bouton (Ex: "12")
            nosBtn.innerText = bondAmmo;
            // Barre bleue = progression vers le rechargement (0 √† 100 voitures)
            nosBarFill.style.width = (bondOvertakeCount / 100 * 100) + "%";
            
            // Couleur bouton : Rouge si vide, Vert si pr√™t
            if(bondAmmo > 0) {
                nosBtn.classList.add('ready');
                nosBtn.style.border = "2px solid #00ff00"; // Vert quand pr√™t
                nosBtn.style.color = "#00ff00";
            } else {
                nosBtn.classList.remove('ready');
                nosBtn.style.borderColor = "red";
                nosBtn.style.color = "red";
            }
        }
        // ------------------------------------
        
        let scoreMult = (currentVipMode && currentVipMode.id === "GOLDEN") ? 2 : 1;
        distance += (speed / 1000) * scoreMult; 
        
        distEl.innerText = distance.toFixed(1);
        elapsedTime = now - startTime; timerEl.innerText = formatTime(elapsedTime);
        speedValEl.innerHTML = `${Math.floor(speed * 10)} km/h`; 

        let currentCarData = currentVipMode || carsData[currentCarIndex];
        
        if(!currentVipMode && !isNosActive) { 
            nosLevel = Math.min(100, nosLevel); 
            nosBarFill.style.width = nosLevel + "%";
            if (nosLevel >= 100) { nosBtn.classList.add('ready'); nosBtn.style.opacity = '1'; } else { nosBtn.classList.remove('ready'); nosBtn.style.opacity = '0.6'; }
        }
        if(currentVipMode && ["JUMP", "SPECTRE"].includes(currentVipMode.id)) { nosBarFill.style.width = nosLevel + "%"; }
        if(currentVipMode && currentVipMode.id === "POLICE") { nosLevel = 100; nosBarFill.style.width = "100%"; nosBtn.classList.add('ready'); nosBtn.style.opacity = '1'; }
        
        // DESSIN SCENE
        ctx.fillStyle = "#1a1a2e"; ctx.fillRect(0,0,canvas.width,canvas.height);
        if(bgImage.complete) { ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height); } 
        if(isIceActive) ctx.fillStyle = "#2c3e50"; else ctx.fillStyle = "#2c2c2c";
        ctx.fillRect(ROAD_LEFT, 0, ROAD_WIDTH, canvas.height);
        ctx.fillStyle = "#ffffff"; ctx.fillRect(ROAD_LEFT, 0, 4, canvas.height); ctx.fillRect(ROAD_RIGHT - 4, 0, 4, canvas.height);
        let line1X = ROAD_LEFT + LANE_WIDTH; let line2X = ROAD_LEFT + (LANE_WIDTH * 2);
        ctx.fillStyle = "rgba(255, 255, 255, 0.5)"; 
        roadLines = roadLines.filter((l) => {
            l.y += speed; ctx.fillRect(line1X - 2, l.y, 4, 30); ctx.fillRect(line2X - 2, l.y, 4, 30);
            return l.y <= canvas.height;
        });

        if(isPhotoActive) {
            photoZoneY += speed; 
            if (spottersImage.complete) {
                let spotterW = ROAD_LEFT * 0.8; let spotterH = spotterW * (spottersImage.height / spottersImage.width); let spotterX = ROAD_LEFT - spotterW - 10;
                ctx.drawImage(spottersImage, spotterX, photoZoneY, spotterW, spotterH);
            }
            
            // --- DESSIN DES 3 ZONES ---
            // 1. Zone B (Rouge - Large) : +/- 150px
            ctx.fillStyle = "rgba(255, 0, 0, 0.3)"; 
            ctx.fillRect(ROAD_LEFT, photoZoneY - 150, ROAD_WIDTH, 300);
            
            // 2. Zone A (Orange - Moyenne) : +/- 90px
            ctx.fillStyle = "rgba(255, 165, 0, 0.4)"; 
            ctx.fillRect(ROAD_LEFT, photoZoneY - 90, ROAD_WIDTH, 180);

            // 3. Zone S (Verte - Petite/Centre) : +/- 40px
            ctx.fillStyle = "rgba(0, 255, 0, 0.6)"; 
            ctx.fillRect(ROAD_LEFT, photoZoneY - 40, ROAD_WIDTH, 80);
            
            // Ligne centrale pour viser
            ctx.fillStyle = "#fff";
            ctx.fillRect(ROAD_LEFT, photoZoneY - 1, ROAD_WIDTH, 2);

            ctx.fillStyle = "#ffffff"; ctx.font = "bold 20px Courier New"; ctx.textAlign = "center"; ctx.fillText("ZONE PHOTO", ROAD_LEFT + ROAD_WIDTH/2, photoZoneY - 160);

            if(photoZoneY > canvas.height + 200 && !isPosing) isPhotoActive = false; 
        }

        let moveFactor = isIceActive ? 0.03 : 0.15 * handling;
        player.x += (player.targetX - player.x) * moveFactor;
        
        let opacity = (isInvincible && (Math.floor(now/100)%2===0)) ? 0.5 : 1;
        if(currentVipMode && currentVipMode.id === "SPECTRE" && isInvincible) opacity = 0.3;
        if(isInvincible && Date.now() > invincibilityTimer) isInvincible = false;

        // DESSIN PROJECTILES (BOND)
        for(let i=0; i<projectiles.length; i++) {
            let p = projectiles[i]; p.y -= 20;
            ctx.fillStyle = "yellow"; ctx.fillRect(p.x, p.y, p.w, p.h);
            if(p.y < 0) { projectiles.splice(i, 1); i--; }
        }

        // DESSIN VOITURE JOUEUR
        if(isNosActive || (currentVipMode && currentVipMode.id === "POLICE")) {
            ctx.fillStyle = "rgba(0, 200, 255, 0.6)"; ctx.beginPath();
            ctx.moveTo(player.x + 10, player.y + CAR_H); ctx.lineTo(player.x + CAR_W/2, player.y + CAR_H + 40 + Math.random()*20); ctx.lineTo(player.x + CAR_W - 10, player.y + CAR_H); ctx.fill();
            player.x += (Math.random()-0.5)*2;
        }
        
        // JUMP EFFECT
        let drawW = CAR_W; let drawH = CAR_H;
        if(isJumping) {
            drawW *= 1.5; drawH *= 1.5; 
            ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(player.x + 10, player.y + 50, CAR_W, CAR_H/2); // Ombre
        }
        // MICRO MACHINE EFFECT
        if(currentVipMode && currentVipMode.id === "MICRO") { drawW *= 0.6; drawH *= 0.6; }
        
        // CORRECTION DE LA SOURCE D'IMAGE
        let displayImg = currentCarData.imgObj || loadedImages[currentCarIndex];

        drawRotated(ctx, displayImg, player.x - (drawW-CAR_W)/2, player.y - (drawH-CAR_H)/2, drawW, drawH, ROTATION_ANGLE - ((player.x - player.targetX) * 0.5), opacity);

        // RADARS
        radars = radars.filter((r) => {
            r.y += speed; ctx.fillStyle = "#888"; ctx.fillRect(r.x, r.y, 5, 50); ctx.fillStyle = "#444"; ctx.fillRect(r.x-10, r.y, 15, 20); ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.fillRect(ROAD_LEFT, r.y + 100, ROAD_WIDTH, 5);
            if (!r.passed && r.y + 100 > player.y + 20) { 
                r.passed = true;
                if (speed * 10 > RADAR_SPEED_LIMIT) { triggerFlash(); lives--; updateHearts(); if(lives <= 0) { gameOver('FLASH'); } else { showAlert(`FLASH√â !`, "red", "white"); } }
            }
            return r.y <= canvas.height;
        });

        // CONES
        cones = cones.filter((c, i) => {
            c.y += speed; ctx.fillStyle = "orange"; ctx.beginPath(); ctx.moveTo(c.x + 15, c.y); ctx.lineTo(c.x, c.y + 30); ctx.lineTo(c.x + 30, c.y + 30); ctx.fill();
            for(let k=0; k<projectiles.length; k++) {
                let p = projectiles[k];
                if(p.x > c.x + 30 && p.x + p.w > c.x && p.y < c.y + 30 && p.y + p.h > c.y) {
                    cones.splice(i, 1); projectiles.splice(k, 1); return false;
                }
            }
            if(!isInvincible && !isNosActive && !isJumping && player.x < c.x + 30 && player.x + CAR_W > c.x && player.y < c.y + 30 && player.y + CAR_H > c.y) {
                lives--; updateHearts(); if(lives <= 0) { gameOver('CRASH'); } else { isInvincible = true; invincibilityTimer = Date.now() + 2000; showAlert("TRAVAUX !", "orange", "black"); }
            }
            return c.y <= canvas.height;
        });

        bonuses = bonuses.filter((b, i) => {
            b.y += speed; ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("üîß", b.x + b.w/2, b.y + b.h/2);
            if (player.x < b.x + b.w && player.x + CAR_W > b.x && player.y < b.y + b.h && player.y + CAR_H > b.y) {
                if(lives < (hasExtraLives ? 10 : 3)) { lives++; updateHearts(); } return false;
            }
            return b.y <= canvas.height;
        });

        for (let i = 0; i < obstacles.length; i++) {
            let obs = obstacles[i];
            let mySpeed = speed;
            if (obs.type === 'truck') { obs.x += 0; let enemyBaseSpeed = speed * obs.factor; obs.y += (mySpeed - enemyBaseSpeed); } 
            else {
                let braking = false;
                for(let j = 0; j < obstacles.length; j++) { if (i !== j && obstacles[j].type !== 'truck') { let other = obstacles[j]; if (other.y > obs.y && other.y < obs.y + 200 && Math.abs(other.x - obs.x) < 20) { braking = true; } } }
                let enemyBaseSpeed = speed * obs.factor; if (braking) enemyBaseSpeed = speed; obs.y += (mySpeed - enemyBaseSpeed);
            }
            
            // Check Projectiles
            let hitByProjectile = false;
            for(let k=0; k<projectiles.length; k++) {
                let p = projectiles[k];
                if(p.x > obs.x && p.x < obs.x + CAR_W && p.y < obs.y + CAR_H && p.y > obs.y) {
                    obstacles.splice(i, 1); projectiles.splice(k, 1); i--; hitByProjectile = true; break;
                }
            }
            if(hitByProjectile) continue; 

            let obsOp = isNosActive ? 0.5 : 1;
            if(currentVipMode && currentVipMode.id === "SPECTRE" && isInvincible) obsOp = 0.3;

            if(isTunnelActive && !isNosActive && !(currentVipMode && currentVipMode.id === "POLICE")) { } else {
                if(isFogActive) { let visibility = Math.max(0, (obs.y) / (canvas.height/2)); ctx.globalAlpha = Math.min(1, visibility); }
                if(obs.type === 'truck') {
                     ctx.save(); ctx.translate(obs.x + 30, obs.y + 120); ctx.rotate(-Math.PI / 2); 
                     if (truckImage.complete) { ctx.drawImage(truckImage, -120, -30, 240, 60); } else { ctx.fillStyle = "blue"; ctx.fillRect(-120, -30, 240, 60); }
                     ctx.restore();
                } else { drawRotated(ctx, obs.img, obs.x, obs.y, CAR_W, CAR_H, ROTATION_ANGLE, obsOp); }
                ctx.globalAlpha = 1;
            }
            
            let hit = false;
            let obsW = CAR_W; let obsH = CAR_H;
            if (obs.type === 'truck') { obsW = 60; obsH = 240; }
            let pW = (currentVipMode && currentVipMode.id === "MICRO") ? CAR_W * 0.6 : CAR_W;
            let pH = (currentVipMode && currentVipMode.id === "MICRO") ? CAR_H * 0.6 : CAR_H;

            // Simple AABB Collision Check (player vs obstacle)
            if (!isInvincible && !isNosActive && !isJumping) {
                 // Adjusted hitbox check to be slightly smaller than the drawing size
                 if (player.x < obs.x + obsW - 5 && player.x + pW - 5 > obs.x && player.y < obs.y + obsH - 5 && player.y + pH - 5 > obs.y) { 
                     
                     hit = true; 

                     // --- NOUVELLE LOGIQUE : RABATTEMENT 50% ---
                     // On v√©rifie si le joueur est en train de doubler (queue de poisson)
                     // Si l'arri√®re de ta voiture (player.y + pH) est au-dessus de la ligne des 50% de l'ennemi
                     // Cela veut dire que tu as pass√© 50% de sa voiture.
                     
                     // Point critique : Le haut de l'ennemi (obs.y) + 50% de sa hauteur
                     let safeZoneY = obs.y + (obsH * 0.80); 

                     // Si tes fesses sont devant cette ligne, c'est valid√© !
                     if (player.y + pH < safeZoneY) {
                         hit = false; 
                     }
                     // -------------------------------------------
                 }
            }
            
            if (hit) { 
                if (currentVipMode && currentVipMode.id === "BULLDOZER" && obs.type !== 'truck') {
                     obstacles.splice(i, 1); i--; photoBonusScore += 50 * scoreMult; photoScoreEl.innerText = photoBonusScore;
                } else {
                    lives--; updateHearts(); 
                    if(lives <= 0) { gameOver('CRASH'); } 
                    else { 
                        isInvincible = true; invincibilityTimer = now + 2000; 
                        obs.y += 100; // Move obstacle down to prevent immediate re-collision
                        // ALERT WINDOW REMOVED HERE
                    } 
                }
            }
            
            if(obs.y > canvas.height) {
                if (obs.type !== 'truck' && (!currentVipMode || currentVipMode.id !== "POLICE")) { nosLevel = Math.min(100, nosLevel + 1); }
                
                // --- LOGIQUE DE RECHARGEMENT BOND (OVERTAKE) ---
                if (currentVipMode && currentVipMode.id === "BOND" && obs.type !== 'truck') {
                     if (bondAmmo < 15) {
                         bondOvertakeCount++;
                         if (bondOvertakeCount >= 100) {
                             bondAmmo = 15; // Recharge compl√®te
                             bondOvertakeCount = 0; // Reset
                             showAlert("MISSILES RECHARG√âS !", "#00ff00", "black");
                         }
                     }
                }
                // ------------------------------------------------
                
                obstacles.splice(i, 1); i--;
            }
        }

        if (isTunnelActive) {
            ctx.fillStyle = "rgba(0,0,0,0.98)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.globalCompositeOperation = "destination-out";
            ctx.beginPath(); ctx.moveTo(player.x + 10, player.y + 10); ctx.lineTo(player.x - 20, player.y - 400); ctx.lineTo(player.x + 20, player.y - 400); ctx.fill();
            ctx.beginPath(); ctx.moveTo(player.x + CAR_W - 10, player.y + 10); ctx.lineTo(player.x + CAR_W - 20, player.y - 400); ctx.lineTo(player.x + CAR_W + 20, player.y - 400); ctx.fill();
            ctx.restore();
            obstacles.forEach(obs => {
                 if (obs.type === 'truck') { ctx.fillStyle = "#ff0000"; ctx.shadowColor = "red"; ctx.shadowBlur = 20; ctx.fillRect(obs.x + 10, obs.y + 240 - 5, 10, 5); ctx.fillRect(obs.x + 60 - 20, obs.y + 240 - 5, 10, 5); } 
                 else { ctx.fillStyle = "#ff0000"; ctx.shadowColor = "red"; ctx.shadowBlur = 20; ctx.fillRect(obs.x + 5, obs.y + CAR_H - 5, 8, 5); ctx.fillRect(obs.x + (CAR_W) - 13, obs.y + CAR_H - 5, 8, 5); }
                 ctx.shadowBlur = 0;
            });
        }

        if(isFogActive) { let grad = ctx.createLinearGradient(0, 0, 0, canvas.height/2); grad.addColorStop(0, "rgba(200, 200, 200, 0.95)"); grad.addColorStop(1, "rgba(200, 200, 200, 0)"); ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height); }

        if(isStormActive) {
            let now = Date.now();
            if (lightningState === 0 && now > lightningNextStrike) { lightningLane = Math.floor(Math.random() * 3); lightningState = 1; lightningTimer = now + 1000; }
            if (lightningState === 1) {
                let laneX = getLaneX(lightningLane) + CAR_W/2; let laneY = canvas.height / 2;
                if (Math.floor(now / 100) % 2 === 0) { ctx.font = "80px Arial"; ctx.fillStyle = "red"; ctx.textAlign = "center"; ctx.fillText("‚ö†Ô∏è", laneX, laneY); ctx.fillStyle = "rgba(255, 0, 0, 0.3)"; ctx.fillRect(getLaneX(lightningLane), 0, LANE_WIDTH, canvas.height); }
                if (now > lightningTimer) { lightningState = 2; lightningTimer = now + 300; triggerFlash(); }
            }
            if (lightningState === 2) {
                let laneX = getLaneX(lightningLane) + CAR_W/2; drawLightning(laneX);
                if (!isInvincible && !isNosActive && !isJumping && player.laneIndex === lightningLane) { lives--; updateHearts(); if(lives <= 0) { gameOver('CRASH'); } else { isInvincible = true; invincibilityTimer = Date.now() + 2000; showAlert("FOUDROY√â !", "yellow", "black"); } }
                if (now > lightningTimer) { lightningState = 0; lightningNextStrike = now + 2000 + Math.random() * 2000; }
            }
            ctx.strokeStyle = "rgba(255,255,255,0.5)"; ctx.lineWidth = 1; ctx.beginPath();
            for(let i=0; i<10; i++) { let rx = Math.random() * canvas.width; let ry = Math.random() * canvas.height; ctx.moveTo(rx, ry); ctx.lineTo(rx - 5, ry + 20); } ctx.stroke();
        }

        requestAnimationFrame(loop);
    }

    function drawGameStatic() {
        if(bgImage.complete) { ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height); } 
        ctx.fillStyle = "#2c2c2c"; ctx.fillRect(ROAD_LEFT, 0, ROAD_WIDTH, canvas.height);
        ctx.fillStyle = "#ffffff"; ctx.fillRect(ROAD_LEFT, 0, 4, canvas.height); ctx.fillRect(ROAD_RIGHT - 4, 0, 4, canvas.height);
        let line1X = ROAD_LEFT + LANE_WIDTH; let line2X = ROAD_LEFT + (LANE_WIDTH * 2);
        ctx.fillStyle = "rgba(255, 255, 255, 0.5)"; 
        roadLines.forEach((l) => { ctx.fillRect(line1X - 2, l.y, 4, 30); ctx.fillRect(line2X - 2, l.y, 4, 30); });
        
        if(isPhotoActive) {
            if(spottersImage.complete) {
                 let spotterW = ROAD_LEFT * 0.8; let spotterH = spotterW * (spottersImage.height / spottersImage.width); let spotterX = ROAD_LEFT - spotterW - 10;
                 ctx.drawImage(spottersImage, spotterX, photoZoneY, spotterW, spotterH);
            }
            // DESSIN STATIQUE DES ZONES
            ctx.fillStyle = "rgba(255, 0, 0, 0.3)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 150, ROAD_WIDTH, 300);
            ctx.fillStyle = "rgba(255, 165, 0, 0.4)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 90, ROAD_WIDTH, 180);
            ctx.fillStyle = "rgba(0, 255, 0, 0.6)"; ctx.fillRect(ROAD_LEFT, photoZoneY - 40, ROAD_WIDTH, 80);
            ctx.fillStyle = "#fff"; ctx.fillRect(ROAD_LEFT, photoZoneY - 1, ROAD_WIDTH, 2);
        }
        
        let drawW = CAR_W; let drawH = CAR_H;
        if(currentVipMode && currentVipMode.id === "MICRO") { drawW *= 0.6; drawH *= 0.6; }
        
        let displayImg = currentVipMode ? currentVipMode.imgObj : loadedImages[currentCarIndex];

        drawRotated(ctx, displayImg, player.x - (drawW-CAR_W)/2, player.y - (drawH-CAR_H)/2, drawW, drawH, ROTATION_ANGLE, 1);
        
        obstacles.forEach((obs) => {
            if(obs.type === 'truck') {
                 ctx.save(); ctx.translate(obs.x + 30, obs.y + 120); ctx.rotate(-Math.PI / 2); 
                 if (truckImage.complete) { ctx.drawImage(truckImage, -120, -30, 240, 60); } else { ctx.fillStyle = "blue"; ctx.fillRect(-120, -30, 240, 60); }
                 ctx.restore();
            } else { drawRotated(ctx, obs.img, obs.x, obs.y, CAR_W, CAR_H, 0); }
        });
    }
</script>
</body>
</html>